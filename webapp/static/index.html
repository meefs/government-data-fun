<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGovDash - Government Data Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #11141b;
            --bg-card: #161a24;
            --bg-hover: #1c2030;
            --accent: #00d4aa;
            --accent-dim: #00b894;
            --accent-glow: rgba(0,212,170,0.12);
            --text-primary: #c9d1d9;
            --text-secondary: #9ca8b4;
            --text-muted: #5a6370;
            --border: #1c2030;
            --border-bright: #2a3040;
            --success: #2dd4a0;
            --warning: #e3b341;
            --danger: #f85149;
            --sidebar-width: 240px;
            --mono: 'JetBrains Mono', 'Consolas', monospace;
            --sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: var(--sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        /* Layout */
        .app { display: flex; height: 100vh; }
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-header h1 {
            font-family: var(--mono);
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .sidebar-header p {
            font-family: var(--mono);
            font-size: 10px;
            color: #6b7685;
            margin-top: 4px;
            letter-spacing: 0.5px;
        }
        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .sidebar-nav::-webkit-scrollbar { width: 4px; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: var(--border); border-radius: 0; }
        .nav-section-title {
            font-family: var(--mono);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #6b7685;
            padding: 14px 10px 4px;
            border-top: 1px solid var(--border);
        }
        .nav-section-title:first-child { border-top: none; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 0;
            cursor: pointer;
            font-family: var(--mono);
            font-size: 11px;
            color: #b0b8c4;
            transition: all 0.1s;
            margin-bottom: 1px;
            border-left: 2px solid transparent;
        }
        .nav-item:hover { background: var(--bg-hover); color: #dde3ea; border-left-color: var(--text-muted); }
        .nav-item.active { background: var(--accent-glow); color: var(--accent); border-left-color: var(--accent); font-weight: 500; }
        .nav-item .badge {
            margin-left: auto;
            font-family: var(--mono);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 0;
            background: var(--bg-primary);
            color: #7d8a98;
            border: 1px solid var(--border);
        }
        .nav-item.active .badge { background: rgba(0,212,170,0.15); color: var(--accent); }
        .nav-icon { width: 16px; text-align: center; font-size: 12px; opacity: 0.7; }

        /* Main content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }
        .topbar h2 {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .topbar .source-badge {
            font-family: var(--mono);
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 0;
            background: var(--bg-card);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .sub-tabs {
            display: flex;
            gap: 3px;
            margin-left: auto;
            flex-wrap: wrap;
        }
        .sub-tab {
            font-family: var(--mono);
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.1s;
        }
        .sub-tab:hover { border-color: var(--accent); color: var(--accent); }
        .sub-tab.active { background: var(--accent); color: #0a0c10; border-color: var(--accent); font-weight: 600; }

        /* Search bar */
        .search-bar {
            display: flex;
            gap: 8px;
            padding: 6px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }
        .search-bar input {
            flex: 1;
            padding: 7px 12px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
            transition: border-color 0.15s;
        }
        .search-bar input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-glow); }
        .search-bar input::placeholder { color: var(--text-muted); }
        .search-bar button {
            padding: 7px 14px;
            border-radius: 0;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-family: var(--mono);
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s;
        }
        .search-bar button:hover { background: var(--accent); color: var(--bg-primary); }

        /* Content area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }
        .content::-webkit-scrollbar { width: 5px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 0; }
        .content::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
            font-family: var(--mono);
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-glow { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }

        /* Data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--mono);
            font-size: 11px;
        }
        .data-table th {
            text-align: left;
            padding: 8px 12px;
            background: var(--bg-secondary);
            color: var(--accent-dim);
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--accent-dim);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table tr:hover td { background: var(--bg-hover); color: var(--text-primary); }
        .data-table a {
            color: var(--accent);
            text-decoration: none;
        }
        .data-table a:hover { text-decoration: underline; }

        /* Cards grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 6px;
        }
        .data-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 10px 12px;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }
        .data-card:hover { border-left-color: var(--accent); background: var(--bg-hover); }
        .data-card h3 {
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .data-card p {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 6px;
        }
        .data-card .meta {
            display: flex;
            gap: 12px;
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-muted);
        }
        .data-card .meta a { color: var(--accent); }

        /* Stats consolidated box */
        .stats-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 8px 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .stats-box .stat-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .stats-box .stat-value {
            font-family: var(--mono);
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }
        .stats-box .stat-label {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stats-box .stat-divider {
            width: 1px;
            height: 28px;
            background: var(--border-bright);
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .filter-bar .filter-label {
            font-family: var(--mono);
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 4px;
        }
        .filter-btn {
            font-family: var(--mono);
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.12s;
        }
        .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
        .filter-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 600; }
        .filter-btn .filter-count {
            font-size: 9px;
            opacity: 0.6;
            margin-left: 3px;
        }

        /* View toggle */
        .view-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        .view-btn {
            font-family: var(--mono);
            padding: 3px 10px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.12s;
        }
        .view-btn:hover { border-color: var(--accent); color: var(--accent); }
        .view-btn.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 600; }
        .result-count { font-family: var(--mono); font-size: 10px; color: var(--text-muted); margin-left: auto; }

        /* Chatbot */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }
        .chat-message {
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
        }
        .chat-message.user { justify-content: flex-end; }
        .chat-avatar {
            width: 28px; height: 28px;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            flex-shrink: 0;
        }
        .chat-message.assistant .chat-avatar { background: var(--accent); color: var(--bg-primary); }
        .chat-message.user .chat-avatar { background: var(--border-bright); }
        .chat-bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 0;
            font-size: 13px;
            line-height: 1.6;
        }
        .chat-message.user .chat-bubble {
            background: var(--border-bright);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .chat-message.assistant .chat-bubble {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            white-space: pre-wrap;
        }
        .chat-input-area {
            padding: 8px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }
        .chat-input-area input {
            flex: 1;
            padding: 9px 12px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
        }
        .chat-input-area input:focus { border-color: var(--accent); }
        .chat-input-area button {
            padding: 9px 18px;
            border-radius: 0;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-family: var(--mono);
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s;
        }
        .chat-input-area button:hover { background: var(--accent); color: var(--bg-primary); }

        /* API Key modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-dim);
            border-radius: 0;
            padding: 16px;
            width: 420px;
            max-width: 90%;
            box-shadow: 0 0 40px rgba(0,212,170,0.08);
        }
        .modal h3 { margin-bottom: 16px; font-family: var(--mono); font-size: 14px; color: var(--accent); }
        .modal label {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .modal input, .modal select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
        }
        .modal input:focus, .modal select:focus { border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .modal button {
            padding: 7px 14px;
            border-radius: 0;
            border: 1px solid var(--border);
            cursor: pointer;
            font-family: var(--mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .modal .btn-primary { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); font-weight: 600; }
        .modal .btn-primary:hover { background: var(--accent-dim); }
        .modal .btn-secondary { background: transparent; color: var(--text-secondary); }
        .modal .btn-secondary:hover { border-color: var(--text-muted); }

        /* Welcome page */
        .welcome-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 16px;
        }
        .welcome-container h2 {
            font-family: var(--mono);
            font-size: 22px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .welcome-container .subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 30px;
        }
        .setup-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 12px 14px;
            margin-bottom: 10px;
        }
        .setup-section h3 {
            font-family: var(--mono);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .setup-section p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .setup-section .step {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .setup-section .step-num {
            background: var(--accent);
            color: #fff;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .setup-section .step-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .setup-section .step-text code {
            background: var(--bg-primary);
            padding: 1px 6px;
            border-radius: 0;
            font-size: 12px;
            color: var(--accent);
        }
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 6px;
            margin-top: 12px;
        }
        .provider-card {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.12s;
        }
        .provider-card:hover { border-color: var(--accent); }
        .provider-card.selected { border-color: var(--accent); background: var(--accent-glow); }
        .provider-card h4 { font-family: var(--mono); font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .provider-card .price { font-family: var(--mono); font-size: 10px; color: var(--success); }
        .provider-card .desc { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .provider-setup-option {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 8px;
            text-align: center;
            font-family: var(--mono);
            cursor: pointer;
            transition: all 0.12s;
        }
        .provider-setup-option:hover { border-color: var(--accent); background: var(--accent-glow); }
        .provider-setup-option .pso-name { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .provider-setup-option .pso-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0;
            font-family: var(--mono);
        }
        .provider-setup-option .pso-btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary {
            padding: 9px 20px;
            border-radius: 0;
            border: 1px solid var(--accent);
            background: var(--accent);
            color: var(--bg-primary);
            font-family: var(--mono);
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s;
        }
        .btn-primary:hover { background: var(--accent-dim); }
        .free-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 0;
            background: rgba(52,211,153,0.15);
            color: var(--success);
            font-weight: 600;
        }

        /* Error */
        .error-msg {
            background: rgba(248,81,73,0.08);
            border: 1px solid rgba(248,81,73,0.25);
            border-radius: 0;
            padding: 8px 12px;
            color: var(--danger);
            font-family: var(--mono);
            font-size: 12px;
        }

        /* Overview page */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 6px;
        }
        .agency-overview-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.12s;
            border-left: 2px solid transparent;
        }
        .agency-overview-card:hover { border-left-color: var(--accent); background: var(--bg-hover); }
        .agency-overview-card h3 {
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 2px;
        }
        .agency-overview-card .acronym {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .agency-overview-card p {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        .agency-overview-card .tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .tag {
            font-family: var(--mono);
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 0;
            background: var(--bg-primary);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        /* Agency preview items */
        .agency-preview-item {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-secondary);
            padding: 3px 0;
            border-top: 1px solid var(--border);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .agency-preview-item:first-child { border-top: none; }
        .agency-preview-item .preview-date {
            color: var(--text-muted);
            margin-right: 6px;
        }
        /* Chat suggestions */
        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px 16px;
        }
        .suggestion-chip {
            padding: 5px 12px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--mono);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.12s;
        }
        .suggestion-chip:hover { border-color: var(--accent); color: var(--accent); }

        /* SVG icons inline */
        .svg-icon { display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
        .svg-icon svg { display: block; }
        .ep-icon .svg-icon svg { width: 16px; height: 16px; }

        /* FCC Detail View */
        .fcc-detail-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .fcc-detail-header {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .fcc-detail-header h3 {
            font-family: var(--mono);
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }
        .fcc-detail-header .fcc-id-badge {
            font-family: var(--mono);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 0;
            background: var(--accent-glow);
            color: var(--accent);
            border: 1px solid var(--accent-dim);
            letter-spacing: 0.5px;
        }
        .fcc-detail-body {
            padding: 10px 12px;
        }
        .fcc-field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }
        .fcc-field {
            padding: 6px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 0;
        }
        .fcc-field-label {
            font-family: var(--mono);
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 3px;
        }
        .fcc-field-value {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--text-primary);
            word-break: break-all;
        }
        .fcc-field-value a { color: var(--accent); text-decoration: none; }
        .fcc-field-value a:hover { text-decoration: underline; }
        .fcc-detail-links {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .fcc-link-btn {
            font-family: var(--mono);
            font-size: 10px;
            padding: 5px 12px;
            border-radius: 0;
            border: 1px solid var(--accent-dim);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.12s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .fcc-link-btn:hover { background: var(--accent); color: var(--bg-primary); }
        .fcc-results-list { }
        .fcc-result-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 8px 12px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.12s;
            border-left: 2px solid transparent;
        }
        .fcc-result-item:hover { border-left-color: var(--accent); background: var(--bg-hover); }
        .fcc-result-item.expanded { border-left-color: var(--accent); border-color: var(--accent-dim); }
        .fcc-result-summary {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .fcc-result-summary .fcc-rid {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--accent);
            font-weight: 600;
            min-width: 120px;
        }
        .fcc-result-summary .fcc-rdesc {
            font-size: 12px;
            color: var(--text-primary);
            flex: 1;
        }
        .fcc-result-summary .fcc-rdate {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--text-muted);
        }
        .fcc-result-detail {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .fcc-result-item.expanded .fcc-result-detail { display: block; }

        /* Agency Landing Page */
        .agency-landing {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 0;
        }
        .agency-landing-header {
            margin-bottom: 12px;
        }
        .agency-landing-header h2 {
            font-family: var(--mono);
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .agency-landing-header p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .agency-landing-header .landing-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .agency-landing-header .landing-meta span {
            font-family: var(--mono);
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 0;
            border: 1px solid var(--border);
        }
        .endpoint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 6px;
            margin-bottom: 14px;
        }
        .endpoint-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.12s;
            border-left: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .endpoint-card:hover {
            border-left-color: var(--accent);
            background: var(--bg-hover);
        }
        .endpoint-card .ep-icon {
            font-size: 16px;
            line-height: 1;
        }
        .endpoint-card .ep-name {
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .endpoint-card .ep-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .endpoint-card .ep-tag {
            font-family: var(--mono);
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: auto;
        }
        .landing-search-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 10px 12px;
            margin-bottom: 14px;
        }
        .landing-search-section h4 {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .landing-search-row {
            display: flex;
            gap: 8px;
        }
        .landing-search-row input {
            flex: 1;
            padding: 9px 12px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
        }
        .landing-search-row input:focus { border-color: var(--accent); }
        .landing-search-row input::placeholder { color: var(--text-muted); }
        .landing-search-row button {
            padding: 9px 16px;
            border-radius: 0;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-family: var(--mono);
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.15s;
        }
        .landing-search-row button:hover { background: var(--accent); color: var(--bg-primary); }

        /* Fetch controls */
        .fetch-controls {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 8px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .fetch-controls .fc-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .fetch-controls label {
            font-family: var(--mono);
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .fetch-controls select,
        .fetch-controls input[type="date"] {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--mono);
            font-size: 11px;
            outline: none;
        }
        .fetch-controls select:focus,
        .fetch-controls input[type="date"]:focus { border-color: var(--accent); }
        .fetch-controls input[type="date"] { width: 130px; }
        .fetch-controls select { min-width: 60px; }
        .fetch-controls .fc-divider {
            width: 1px;
            height: 20px;
            background: var(--border-bright);
        }
    </style>
</head>
<body>
<div class="app" id="app">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>OpenGovDash</h1>
            <p>Research Terminal v1.0</p>
        </div>
        <div class="sidebar-nav" id="sidebar-nav">
            <div class="nav-item" onclick="showWelcome()" data-page="welcome">
                Setup
            </div>
            <div class="nav-item active" onclick="showOverview()" data-page="overview">
                Overview
            </div>
            <div class="nav-item" onclick="showChat()" data-page="chat">
                AI Chatbot
                <span class="badge">Cross-Ref</span>
            </div>
            <div style="height:1px;background:var(--border);margin:8px 0;"></div>
            <div id="agency-nav-list">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <!-- Overview Page -->
        <div id="page-overview">
            <div class="topbar">
                <h2><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="var(--accent)" stroke-width="1.5" style="vertical-align:middle;margin-right:6px;"><rect x="2" y="2" width="12" height="12" rx="1"/><path d="M5 5h6m-6 3h4m-4 3h6"/></svg>Research Terminal</h2>
                <span class="source-badge" id="agency-count">Loading...</span>
            </div>
            <div class="content" id="overview-content">
                <div class="loading"><div class="spinner"></div>Initializing...</div>
            </div>
        </div>

        <!-- Welcome/Setup Page -->
        <div id="page-welcome" style="display:none;flex-direction:column;height:100%;">
            <div class="content">
                <div class="welcome-container">
                    <h2>Welcome to OpenGovDash</h2>
                    <p class="subtitle">Access 21 government databases with 53+ data endpoints. Browse data freely or set up AI for cross-referencing.</p>

                    <div class="setup-section">
                        <h3><span class="svg-icon" style="margin-right:6px;color:var(--accent);"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8.5l3.5 3.5 6.5-7"/></svg></span>Browse Data — No Setup Required</h3>
                        <p>Most government APIs are open access. Click any agency in the sidebar to start exploring data immediately. Agencies marked OPEN require no authentication.</p>
                    </div>

                    <div class="setup-section">
                        <h3><span class="svg-icon" style="margin-right:6px;color:var(--accent);"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="10" height="8" rx="1"/><path d="M6 9h0m4 0h0" stroke-linecap="round"/><path d="M8 5V3m-4 4H2m12 0h-2"/></svg></span>AI Chatbot Setup (Optional)</h3>
                        <p>The AI chatbot can cross-reference data across agencies, answer questions, and build dashboards. Choose your AI provider:</p>
                        <div class="provider-grid" id="provider-grid">
                            <div class="provider-card selected" onclick="selectProvider('free')">
                                <h4>Free Mode</h4>
                                <div class="price"><span class="free-badge">FREE</span> No API key needed</div>
                                <div class="desc">Uses free open-source models via HuggingFace. No key needed.</div>
                            </div>
                            <div class="provider-card" onclick="selectProvider('openai')">
                                <h4>OpenAI</h4>
                                <div class="price">Pay-per-use</div>
                                <div class="desc">GPT-4o-mini. Best quality responses.</div>
                            </div>
                            <div class="provider-card" onclick="selectProvider('groq')">
                                <h4>Groq</h4>
                                <div class="price"><span class="free-badge">FREE TIER</span></div>
                                <div class="desc">Llama 3 70B. Very fast inference.</div>
                            </div>
                            <div class="provider-card" onclick="selectProvider('gemini')">
                                <h4>Google Gemini</h4>
                                <div class="price"><span class="free-badge">FREE TIER</span></div>
                                <div class="desc">Gemini 2.0 Flash. Google AI.</div>
                            </div>
                            <div class="provider-card" onclick="selectProvider('claude')">
                                <h4>Anthropic Claude</h4>
                                <div class="price">Pay-per-use</div>
                                <div class="desc">Claude Sonnet. Great at analysis.</div>
                            </div>
                        </div>
                        <div id="provider-key-input" style="margin-top:12px;display:none;">
                            <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;" id="provider-key-label">OpenAI API Key</label>
                            <input id="welcome-api-key" type="password" placeholder="sk-..." style="width:100%;padding:8px 12px;border-radius:0;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:13px;outline:none;">
                        </div>
                    </div>

                    <div class="setup-section">
                        <h3><span class="svg-icon" style="margin-right:6px;color:var(--accent);"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5.5" cy="6.5" r="2.5"/><path d="M7.5 8.5l5 5m-2-1l2 1-1-2"/></svg></span>Quick Setup: Add More AI Providers (Optional)</h3>
                        <p style="font-size:12px;margin-bottom:10px;">Add up to 3 providers for reliable access. Start with Free Mode — upgrade anytime.</p>
                        <div id="multi-provider-setup" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:12px;">
                            <div class="provider-setup-option" data-provider="openai">
                                <div class="pso-name">OpenAI</div>
                                <div class="pso-status" style="font-size:10px;color:var(--text-muted);">Not set</div>
                                <button class="pso-btn" onclick="startMultiProviderSetup('openai')" style="font-size:10px;padding:4px 8px;margin-top:4px;">Add</button>
                            </div>
                            <div class="provider-setup-option" data-provider="groq">
                                <div class="pso-name">Groq</div>
                                <div class="pso-status" style="font-size:10px;color:var(--text-muted);">Not set</div>
                                <button class="pso-btn" onclick="startMultiProviderSetup('groq')" style="font-size:10px;padding:4px 8px;margin-top:4px;">Add</button>
                            </div>
                            <div class="provider-setup-option" data-provider="gemini">
                                <div class="pso-name">Gemini</div>
                                <div class="pso-status" style="font-size:10px;color:var(--text-muted);">Not set</div>
                                <button class="pso-btn" onclick="startMultiProviderSetup('gemini')" style="font-size:10px;padding:4px 8px;margin-top:4px;">Add</button>
                            </div>
                        </div>
                    </div>

                    <div class="setup-section">
                        <h3><span class="svg-icon" style="margin-right:6px;color:var(--accent);"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5.5" cy="6.5" r="2.5"/><path d="M7.5 8.5l5 5m-2-1l2 1-1-2"/></svg></span>Optional: Enhanced API Keys</h3>
                        <p>Some agencies offer better access with a <code>data.gov</code> API key. Get one free at <a href="https://api.data.gov/signup/" target="_blank" style="color:var(--accent)">api.data.gov/signup</a></p>
                        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;margin-top:8px;">data.gov API Key (optional)</label>
                        <input id="welcome-datagov-key" type="text" placeholder="Your data.gov API key" style="width:100%;padding:8px 12px;border-radius:0;border:1px solid var(--border);background:var(--bg-primary);color:var(--text-primary);font-size:13px;outline:none;">
                    </div>

                    <button class="btn-primary" onclick="completeSetup()">Start Exploring &#8594;</button>
                    <button class="btn-primary" onclick="completeSetup()" style="background:transparent;border:1px solid var(--border);color:var(--text-secondary);margin-left:8px;">Skip Setup</button>
                </div>
            </div>
        </div>

        <!-- Agency Data Page -->
        <div id="page-agency" style="display:none;flex-direction:column;height:100%;">
            <div class="topbar">
                <h2 id="agency-title">Agency</h2>
                <span class="source-badge" id="agency-source"></span>
                <div class="sub-tabs" id="sub-tabs"></div>
            </div>
            <div id="search-bar-container"></div>
            <div id="data-fetch-controls"></div>
            <div class="view-controls">
                <button class="view-btn active" onclick="setView('cards')" id="btn-cards">Cards</button>
                <button class="view-btn" onclick="setView('table')" id="btn-table">Table</button>
                <span class="result-count" id="result-count"></span>
            </div>
            <div class="content" id="agency-content">
                <div class="loading"><div class="spinner"></div>Loading data...</div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="page-chat" style="display:none;flex-direction:column;height:100%;">
            <div class="topbar">
                <h2>AI Cross-Reference Chatbot</h2>
                <span class="source-badge" id="chat-provider-badge">Powered by AI</span>
                <button onclick="showApiKeyModal()" style="margin-left:auto;padding:6px 12px;border-radius:0;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--mono);"><svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:middle;margin-right:4px;"><circle cx="5.5" cy="6.5" r="2.5"/><path d="M7.5 8.5l5 5m-2-1l2 1-1-2"/></svg>API Key</button>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message assistant">
                        <div class="chat-avatar"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="10" height="8" rx="1"/><path d="M6 9h0m4 0h0" stroke-linecap="round"/><path d="M8 5V3m-4 4H2m12 0h-2"/></svg></div>
                        <div class="chat-bubble">Welcome! I can help you cross-reference data across all government databases. Try asking me about connections between agencies, data patterns, or specific regulatory questions.

Free mode is active — no API key needed, just start chatting. For alternate providers, use the API Key button above.</div>
                    </div>
                </div>
                <div class="chat-suggestions" id="chat-suggestions">
                    <button class="suggestion-chip" onclick="sendSuggestion(this)">What SEC filings relate to FDA drug approvals?</button>
                    <button class="suggestion-chip" onclick="sendSuggestion(this)">Look up FCC ID 2ABCB and cross-reference with FDA 510(k)</button>
                    <button class="suggestion-chip" onclick="sendSuggestion(this)">How do NIST CVEs connect to FTC enforcement?</button>
                    <button class="suggestion-chip" onclick="sendSuggestion(this)">Show relationships between Treasury data and FDIC banks</button>
                    <button class="suggestion-chip" onclick="sendSuggestion(this)">Create a dashboard of BLS employment vs Census demographics</button>
                </div>
                <div class="chat-input-area">
                    <input id="chat-input" placeholder="Ask about cross-referencing government data..." onkeydown="if(event.key==='Enter')sendChat()">
                    <button onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Key Modal -->
<div id="api-key-modal" class="modal-overlay" style="display:none;">
    <div class="modal">
        <h3><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="vertical-align:middle;margin-right:4px;"><circle cx="5.5" cy="6.5" r="2.5"/><path d="M7.5 8.5l5 5m-2-1l2 1-1-2"/></svg> AI Provider Settings</h3>
        <label>AI Provider</label>
        <select id="modal-provider-select" onchange="modalProviderChange()" style="width:100%;padding:8px 12px;border-radius:0;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:13px;outline:none;">
            <option value="free">Free Mode (HuggingFace)</option>
            <option value="openai">OpenAI (GPT-4o-mini)</option>
            <option value="groq">Groq (Llama 3 70B)</option>
            <option value="gemini">Google Gemini (Flash)</option>
            <option value="claude">Anthropic Claude (Sonnet)</option>
        </select>
        <div id="modal-key-section">
            <label id="modal-key-label">API Key</label>
            <input id="modal-key-input" type="password" placeholder="Enter API key...">
        </div>
        <label>data.gov API Key (optional, for enhanced access)</label>
        <input id="datagov-key-input" type="text" placeholder="Your data.gov API key">
        <div class="btn-row">
            <button class="btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
            <button class="btn-primary" onclick="saveApiKeys()">Save</button>
        </div>
    </div>
</div>

<!-- Provider Setup Modal -->
<div id="provider-setup-modal" class="modal-overlay" style="display:none;">
    <div class="modal" style="max-width:450px;">
        <h3 style="margin-bottom:16px;">Set up Provider</h3>
        <div class="setup-content"></div>
    </div>
</div>

<script>
// Minimalist SVG icon system
function svgIcon(name, size = 16) {
    const s = size;
    const icons = {
        // UI icons
        'check': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8.5l3.5 3.5 6.5-7"/></svg>`,
        'bot': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="10" height="8" rx="1"/><path d="M6 9h0m4 0h0" stroke-linecap="round"/><path d="M8 5V3m-4 4H2m12 0h-2"/></svg>`,
        'key': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5.5" cy="6.5" r="2.5"/><path d="M7.5 8.5l5 5m-2-1l2 1-1-2"/></svg>`,
        'gear': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="2"/><path d="M8 2v2m0 8v2M2 8h2m8 0h2M3.8 3.8l1.4 1.4m5.6 5.6l1.4 1.4M12.2 3.8l-1.4 1.4M5.2 10.8l-1.4 1.4"/></svg>`,
        'gift': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="6" width="12" height="3"/><rect x="3" y="9" width="10" height="5"/><path d="M8 6v8M5 6c0-2 3-3 3-3s3 1 3 3"/></svg>`,
        'lock': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="7" width="8" height="7" rx="1"/><path d="M6 7V5a2 2 0 014 0v2"/></svg>`,
        'unlock': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="7" width="8" height="7" rx="1"/><path d="M6 7V5a2 2 0 014 0"/></svg>`,
        'search': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="7" cy="7" r="4"/><path d="M10 10l3.5 3.5"/></svg>`,
        'user': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="5" r="2.5"/><path d="M3 14c0-3 2.2-5 5-5s5 2 5 5"/></svg>`,
        'play': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="currentColor"><path d="M5 3l8 5-8 5V3z"/></svg>`,
        'arrow-right': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10m-4-4l4 4-4 4"/></svg>`,
        'globe': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M2 8h12M8 2c2 2 3 4 3 6s-1 4-3 6c-2-2-3-4-3-6s1-4 3-6"/></svg>`,
        'doc': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 2h5l4 4v8H4V2z"/><path d="M9 2v4h4"/></svg>`,
        'mail': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="12" height="10" rx="1"/><path d="M2 4l6 5 6-5"/></svg>`,
        // Domain icons
        'pill': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="2" width="6" height="12" rx="3"/><path d="M5 8h6"/></svg>`,
        'alert': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l6.5 11H1.5L8 2z"/><path d="M8 7v2.5m0 1.5h0" stroke-linecap="round"/></svg>`,
        'device': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="2" width="10" height="12" rx="1"/><path d="M7 12h2"/></svg>`,
        'food': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7c0-3 2-5 5-5s5 2 5 5H3zm0 0v2c0 1 2 2 5 2s5-1 5-2V7"/></svg>`,
        'dollar': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v12m3-9.5c0-1.4-1.3-2.5-3-2.5s-3 1.1-3 2.5 1.3 2.5 3 2.5 3 1.1 3 2.5-1.3 2.5-3 2.5-3-1.1-3-2.5"/></svg>`,
        'chart-up': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12l4-4 3 2 5-6"/><path d="M10 4h4v4"/></svg>`,
        'chart-bar': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 14V8m3.5 6V5m3.5 9V3m3.5 11V6"/></svg>`,
        'exchange': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 5h12m-3-3l3 3-3 3m1 3H2m3 3l-3-3 3-3"/></svg>`,
        'cloud': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12a3 3 0 01-.5-6A5 5 0 0113 7a3 3 0 01-1 6H4z"/></svg>`,
        'quake': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 8h2l2-4 2 8 2-8 2 4h4"/></svg>`,
        'droplet': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2S4 7 4 10a4 4 0 008 0c0-3-4-8-4-8z"/></svg>`,
        'star': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l1.8 4h4.2l-3.4 2.8 1.3 4.2L8 10.5 4.1 13l1.3-4.2L2 6h4.2z"/></svg>`,
        'asteroid': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="4"/><path d="M5 4l-2-2m9 2l2-2m-9 10l-2 2m9-2l2 2"/></svg>`,
        'rocket': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2c0 0-5 3-5 9h10c0-6-5-9-5-9zm0 9v3m-3-3l-1 3m7-3l1 3"/></svg>`,
        'briefcase': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="5" width="12" height="9" rx="1"/><path d="M6 5V3h4v2"/></svg>`,
        'people': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5.5" cy="5" r="2"/><circle cx="10.5" cy="5" r="2"/><path d="M1 14c0-2.5 2-4.5 4.5-4.5.8 0 1.5.2 2.1.5m2.9-.5c2.5 0 4.5 2 4.5 4.5"/></svg>`,
        'newspaper': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="12" rx="1"/><path d="M5 5h6m-6 3h4m-4 3h6"/></svg>`,
        'pencil': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M11.5 2.5l2 2L5 13H3v-2l8.5-8.5z"/></svg>`,
        'mic': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="2" width="4" height="7" rx="2"/><path d="M4 8a4 4 0 008 0m-4 4v2"/></svg>`,
        'megaphone': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3v10L5 10V6l7-3zm-7 3H3v4h2"/></svg>`,
        'radio': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="5" width="10" height="9" rx="1"/><path d="M6 10h0m4 0h0M4 5l8-3"/></svg>`,
        'wifi': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 6c3.5-3 8.5-3 12 0M4.5 9c2-2 5-2 7 0M7 12c.6-.6 1.4-.6 2 0"/></svg>`,
        'scale': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v11M4 14h8M3 5l5-1 5 1M3 5l-1 4h4L3 5zm10 0l-1 4h4l-3-4z"/></svg>`,
        'shield': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l5 2v4c0 3-2 5-5 6-3-1-5-3-5-6V4l5-2z"/></svg>`,
        'vote': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="10" height="6" rx="1"/><path d="M8 5v5m-3-3l3-3 3 3"/></svg>`,
        'bank': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 6l6-4 6 4H2zm1 1v5m3-5v5m3-5v5m3-5v5M2 12h12"/></svg>`,
        'siren': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12V8a4 4 0 018 0v4H4zm-1 0h10m-7 2h4M8 2v1m-5 2l.7.7M13 5l-.7.7"/></svg>`,
        'flask': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2h4m-3 0v5L3 13h10L9 7V2"/></svg>`,
        'book': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 2h10v12H3zm0 0c2 0 3 1 3 2v10c0-1-1-2-3-2"/></svg>`,
        'scroll': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 2h8v10c0 1-1 2-2 2H5c-1 0-2-1-2-2V4c0-1 1-2 2-2z"/><path d="M7 6h4m-4 3h4"/></svg>`,
        'car': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l1.5-4h7L13 9m-10 0h10v3H3V9z"/><circle cx="5" cy="12" r="1"/><circle cx="11" cy="12" r="1"/></svg>`,
        'factory': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 14V8l4-2v2l4-2v2l4-2v6H2z"/><path d="M5 14v-3m4 3v-3"/></svg>`,
        'hazard': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 5v3m0 2.5h0" stroke-linecap="round"/></svg>`,
        'building': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="2" width="10" height="12"/><path d="M6 5h1m2 0h1M6 8h1m2 0h1M7 12h2v2H7z"/></svg>`,
        'trophy': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 2h6v5c0 2-1.5 3-3 3S5 9 5 7V2z"/><path d="M5 4H3v2c0 1 1 2 2 2m6-4h2v2c0 1-1 2-2 2M6 12h4m-2-2v2"/></svg>`,
        'clipboard': `<svg width="${s}" height="${s}" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="10" height="11" rx="1"/><path d="M6 2h4v2H6V2zm0 6h4m-4 3h2"/></svg>`,
    };
    return icons[name] || icons['doc'];
}
const API_BASE = '';  // Same origin for Flask backend
let agencies = [];
let currentAgency = null;
let currentSubSection = '';
let currentData = [];
let currentView = 'cards';
let fetchLimit = 20;
let fetchDateFrom = '';
let fetchDateTo = '';
let chatHistory = [];
let openaiKey = '';
let datagovKey = '';
let aiProvider = 'free'; // 'openai', 'groq', 'gemini', 'claude', 'free'
let groqKey = '';
let geminiKey = '';
let claudeKey = '';
let useDirectApi = false;  // Will be set to true if Flask backend unavailable

// API state tracking - check if providers are configured
const apiState = {
    free: { configured: true, name: 'Free Mode', needsKey: false, requiresSetup: false },
    openai: { configured: false, name: 'OpenAI GPT-4o', needsKey: true, setupUrl: 'https://platform.openai.com/api-keys', setupSteps: ['Visit OpenAI API Keys page', 'Sign in or create account', 'Click "Create new secret key"', 'Copy the key and paste it here'] },
    groq: { configured: false, name: 'Groq Llama 3', needsKey: true, setupUrl: 'https://console.groq.com/keys', setupSteps: ['Visit Groq Console', 'Sign up with email', 'Go to API Keys section', 'Copy key and paste it here'] },
    gemini: { configured: false, name: 'Google Gemini', needsKey: true, setupUrl: 'https://aistudio.google.com/app/apikey', setupSteps: ['Visit Google AI Studio', 'Sign in with Google account', 'Click "Create API key"', 'Copy and paste here (no credit card needed)'] },
    claude: { configured: false, name: 'Anthropic Claude', needsKey: true, setupUrl: 'https://console.anthropic.com/api', setupSteps: ['Visit Anthropic Console', 'Sign in or create account', 'Go to API Keys', 'Create and copy new key'] },
};

function updateApiState() {
    apiState.openai.configured = !!openaiKey;
    apiState.groq.configured = !!groqKey;
    apiState.gemini.configured = !!geminiKey;
    apiState.claude.configured = !!claudeKey;

    // Also refresh welcome page badges if they exist
    document.querySelectorAll('.provider-setup-option').forEach(el => {
        const prov = el.dataset.provider;
        const status = el.querySelector('.pso-status');
        const btn = el.querySelector('.pso-btn');
        if (status && btn && apiState[prov]) {
            if (apiState[prov].configured) {
                status.textContent = '✓ Added';
                status.style.color = 'var(--accent)';
                btn.textContent = 'Update';
            } else {
                status.textContent = 'Not set';
                status.style.color = 'var(--text-muted)';
                btn.textContent = 'Add';
            }
        }
    });

    // Update chat provider badge if visible
    const badge = document.getElementById('chat-provider-badge');
    if (badge) {
        const names = { free: 'Free (HuggingFace)', openai: 'OpenAI GPT-4o', groq: 'Groq Llama 3', gemini: 'Google Gemini', claude: 'Claude Sonnet' };
        badge.textContent = `Powered by ${names[aiProvider] || 'AI'}`;
    }
}

function isProviderReady(provider) {
    if (provider === 'free') return true;
    const state = apiState[provider];
    return state && state.configured;
}

// Smart date formatter that handles various API date formats
function formatDate(dateVal) {
    if (!dateVal) return '';
    const s = String(dateVal).trim();
    // Already formatted strings like "2022 ACS", "Cycle: 2024"
    if (/^(Cycle|FY|Q\d)/i.test(s) || /^\d{4}\s+\w/.test(s)) return s;
    // YYYYMMDD format (FDA style)
    if (/^\d{8}$/.test(s)) {
        const y = s.slice(0,4), m = s.slice(4,6), d = s.slice(6,8);
        return `${m}/${d}/${y}`;
    }
    // MM/DD/YYYY already
    if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
    // Try standard Date parse
    const d = new Date(s);
    if (!isNaN(d.getTime()) && d.getFullYear() > 1900) {
        return d.toLocaleDateString('en-US', {timeZone: 'UTC'});
    }
    // Just return as-is if nothing works
    return s;
}

// CORS proxy wrapper for APIs that block browser requests
async function corsFetch(url, options = {}) {
    try {
        const resp = await fetch(url, options);
        if (resp.ok) return resp;
        throw new Error(`HTTP ${resp.status}`);
    } catch (e) {
        // Try via CORS proxy
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        return fetch(proxyUrl, options);
    }
}

// ========== CLIENT-SIDE DIRECT API LAYER ==========
// These functions call government APIs directly from the browser
const DIRECT_API = {
    sec: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            let dateFilter = '';
            if (opts.dateFrom) dateFilter += `&dateRange=custom&startdt=${opts.dateFrom}`;
            if (opts.dateTo) dateFilter += `&enddt=${opts.dateTo}`;
            if (query) {
                const r = await fetch(`https://efts.sec.gov/LATEST/search-index?q=%22${encodeURIComponent(query)}%22&from=0&size=${lim}${dateFilter}`);
                const d = await r.json();
                return (d.hits?.hits || []).map(h => ({
                    title: h._source?.entity_name || '',
                    description: h._source?.file_description || '',
                    date: h._source?.file_date || '',
                    link: `https://www.sec.gov/cgi-bin/browse-edgar?company=${query}&CIK=&type=&dateb=&owner=include&count=40&search_text=&action=getcompany`,
                    form_type: h._source?.form_type || ''
                }));
            }
            const ft = sub || '8-K';
            const r = await fetch(`https://efts.sec.gov/LATEST/search-index?q=%22${ft}%22&forms=${ft}&from=0&size=${lim}${dateFilter}`);
            const d = await r.json();
            return (d.hits?.hits || []).map(h => ({
                title: (h._source?.display_names || [''])[0] || h._source?.entity_name || '',
                description: `${ft} filing - ${h._source?.file_description || ''}`,
                date: h._source?.file_date || '',
                link: h._source?.entity_id ? `https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${h._source.entity_id}` : '',
                form_type: h._source?.form_type || ft
            }));
        }
    },
    fda: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const endpoints = {
                drug_events: 'drug/event.json',
                drug_recalls: 'drug/enforcement.json',
                device_510k: 'device/510k.json',
                device_recalls: 'device/enforcement.json',
                food_recalls: 'food/enforcement.json'
            };
            const ep = endpoints[sub] || 'drug/event.json';
            let url = `https://api.fda.gov/${ep}?limit=${lim}`;
            if (opts.dateFrom || opts.dateTo) {
                const df = (opts.dateFrom||'2000-01-01').replace(/-/g,'');
                const dt = (opts.dateTo||'2099-12-31').replace(/-/g,'');
                const dateField = (sub === 'drug_events') ? 'receivedate' : 'report_date';
                url += `&search=${dateField}:[${df}+TO+${dt}]`;
            }
            if (query) {
                if (sub === 'drug_events') url += `&search=patient.drug.medicinalproduct:"${query}"`;
                else if (sub === 'device_510k') url += `&search=device_name:"${query}"`;
                else url += `&search="${query}"`;
            }
            const r = await fetch(url);
            const d = await r.json();
            const results = d.results || [];
            if (sub === 'device_510k') {
                return results.map(x => ({
                    title: x.device_name || '', description: `Applicant: ${x.applicant || ''} | Code: ${x.product_code || ''}`,
                    date: x.decision_date || '', link: `https://www.accessdata.fda.gov/scripts/cdrh/cfdocs/cfpmn/pmn.cfm?ID=${x.k_number || ''}`,
                    k_number: x.k_number || '', decision: x.decision_description || ''
                }));
            }
            if (sub === 'drug_events') {
                return results.map(x => {
                    const drugs = x.patient?.drug || [{}];
                    const reactions = x.patient?.reaction || [{}];
                    return {
                        title: drugs[0]?.medicinalproduct || 'Unknown',
                        description: reactions.map(r => r.reactionmeddrapt).filter(Boolean).slice(0,3).join(', '),
                        date: x.receivedate || '', serious: x.serious || '',
                        link: `https://api.fda.gov/drug/event.json?search=safetyreportid:${x.safetyreportid || ''}`
                    };
                });
            }
            return results.map(x => ({
                title: (x.product_description || '').substring(0, 100),
                description: x.reason_for_recall || '',
                date: x.report_date || '',
                link: 'https://www.fda.gov/safety/recalls-market-withdrawals-safety-alerts',
                classification: x.classification || '', recalling_firm: x.recalling_firm || ''
            }));
        }
    },
    treasury: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const endpoints = {
                national_debt: 'v2/accounting/od/debt_to_penny',
                daily_statements: 'v1/accounting/dts/dts_table_1',
                interest_rates: 'v2/accounting/od/avg_interest_rates',
                exchange_rates: 'v1/accounting/od/rates_of_exchange'
            };
            const ep = endpoints[sub] || endpoints.national_debt;
            let dateFilter = '';
            if (opts.dateFrom) dateFilter += `&filter=record_date:gte:${opts.dateFrom}`;
            if (opts.dateTo) dateFilter += `&filter=record_date:lte:${opts.dateTo}`;
            const r = await corsFetch(`https://api.fiscaldata.treasury.gov/services/api/fiscal_service/${ep}?page[size]=${lim}&sort=-record_date${dateFilter}`);
            const d = await r.json();
            const data = d.data || [];
            if (sub === 'national_debt') return data.map(x => ({
                title: `Total Public Debt: $${x.tot_pub_debt_out_amt || 'N/A'}`,
                description: `Debt held by public: $${x.debt_held_public_amt || 'N/A'} | Intragovt: $${x.intragov_hold_amt || 'N/A'}`,
                date: x.record_date || '', link: 'https://fiscaldata.treasury.gov/datasets/debt-to-the-penny/'
            }));
            if (sub === 'interest_rates') return data.map(x => ({
                title: x.security_desc || '', description: `Avg Interest Rate: ${x.avg_interest_rate_amt || ''}%`,
                date: x.record_date || '', link: 'https://fiscaldata.treasury.gov/datasets/average-interest-rates-treasury-securities/'
            }));
            if (sub === 'exchange_rates') return data.map(x => ({
                title: `${x.country || ''} (${x.currency || ''})`,
                description: `Exchange Rate: ${x.exchange_rate || ''} per USD`,
                date: x.record_date || '', link: 'https://fiscaldata.treasury.gov/datasets/treasury-reporting-rates-exchange/'
            }));
            return data.map(x => ({
                title: `${x.account_type || ''} - ${x.classification_desc || ''}`,
                description: `Today: $${x.today_amt || 'N/A'} | MTD: $${x.mtd_amt || 'N/A'}`,
                date: x.record_date || '', link: 'https://fiscaldata.treasury.gov/datasets/daily-treasury-statement/'
            }));
        }
    },
    noaa: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            if (sub === 'forecast') {
                const r = await fetch('https://api.weather.gov/points/38.8894,-77.0352', {headers:{'User-Agent':'OpenGovDash','Accept':'application/geo+json'}});
                const d = await r.json();
                const fr = await fetch(d.properties.forecast, {headers:{'User-Agent':'OpenGovDash','Accept':'application/geo+json'}});
                const fd = await fr.json();
                return (fd.properties?.periods || []).slice(0, lim).map(p => ({
                    title: p.name || '', description: p.detailedForecast || '', date: p.startTime || '',
                    link: 'https://weather.gov', temperature: `${p.temperature}°${p.temperatureUnit}`
                }));
            }
            const r = await fetch('https://api.weather.gov/alerts/active', {headers:{'User-Agent':'OpenGovDash','Accept':'application/geo+json'}});
            const d = await r.json();
            return (d.features || []).slice(0,lim).map(f => ({
                title: f.properties?.headline || '', description: (f.properties?.description || '').substring(0,300),
                date: f.properties?.onset || '', link: f.properties?.uri || 'https://alerts.weather.gov',
                severity: f.properties?.severity || '', area: f.properties?.areaDesc || ''
            }));
        }
    },
    usgs: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            if (sub === 'water') return [{title:'Water monitoring requires backend proxy', description:'USGS Water Services API may have CORS restrictions', date:'', link:'https://waterservices.usgs.gov/'}];
            let dateFilter = '';
            if (opts.dateFrom) dateFilter += `&starttime=${opts.dateFrom}`;
            if (opts.dateTo) dateFilter += `&endtime=${opts.dateTo}`;
            const r = await fetch(`https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&limit=${lim}&minmagnitude=2.5&orderby=time${dateFilter}`);
            const d = await r.json();
            return (d.features || []).map(f => ({
                title: f.properties?.title || '', description: `Magnitude: ${f.properties?.mag} | Depth: ${f.geometry?.coordinates?.[2]}km`,
                date: new Date(f.properties?.time).toISOString(), link: f.properties?.url || '',
                magnitude: f.properties?.mag, tsunami: f.properties?.tsunami
            }));
        }
    },
    nasa: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const key = datagovKey || 'DEMO_KEY';
            if (sub === 'neo') {
                const r = await fetch(`https://api.nasa.gov/neo/rest/v1/neo/browse?api_key=${key}`);
                const d = await r.json();
                return (d.near_earth_objects || []).slice(0,lim).map(n => ({
                    title: n.name || '', description: `Magnitude: ${n.absolute_magnitude_h} | Hazardous: ${n.is_potentially_hazardous_asteroid}`,
                    date: n.orbital_data?.first_observation_date || '', link: n.nasa_jpl_url || ''
                }));
            }
            if (sub === 'mars') {
                const r = await fetch(`https://api.nasa.gov/mars-photos/api/v1/rovers/curiosity/latest_photos?api_key=${key}`);
                const d = await r.json();
                return (d.latest_photos || []).slice(0,lim).map(p => ({
                    title: `Sol ${p.sol} - ${p.camera?.full_name || ''}`, description: `Rover: ${p.rover?.name || ''} | Camera: ${p.camera?.name || ''}`,
                    date: p.earth_date || '', link: p.img_src || ''
                }));
            }
            // Get APOD range — use date controls if set, else last 9 days
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - Math.min(lim - 1, 30));
            const fmt = d => d.toISOString().split('T')[0];
            const apodStart = opts.dateFrom || fmt(startDate);
            const apodEnd = opts.dateTo || fmt(today);
            const r = await fetch(`https://api.nasa.gov/planetary/apod?api_key=${key}&start_date=${apodStart}&end_date=${apodEnd}`);
            const d = await r.json();
            return (Array.isArray(d) ? d : [d]).reverse().map(x => ({
                title: x.title || '', description: (x.explanation || '').substring(0,300),
                date: x.date || '', link: x.hdurl || x.url || '',
                media_type: x.media_type || 'image'
            }));
        }
    },
    bls: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const seriesMap = { unemployment:'LNS14000000', cpi:'CUUR0000SA0', employment:'CES0000000001', avg_hourly_earnings:'CES0500000003' };
            const names = { unemployment:'Unemployment Rate', cpi:'Consumer Price Index', employment:'Total Nonfarm Employment', avg_hourly_earnings:'Avg Hourly Earnings' };
            const sid = seriesMap[sub] || seriesMap.unemployment;
            const name = names[sub] || names.unemployment;
            const year = new Date().getFullYear();
            const startYear = opts.dateFrom ? parseInt(opts.dateFrom.split('-')[0]) : year - 3;
            const endYear = opts.dateTo ? parseInt(opts.dateTo.split('-')[0]) : year;
            try {
                // Try direct API first
                const r = await fetch('https://api.bls.gov/publicAPI/v2/timeseries/data/', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({seriesid:[sid], startyear:String(startYear), endyear:String(endYear)}),
                    signal: AbortSignal.timeout(5000)
                });
                if (r.ok) {
                    const d = await r.json();
                    const series = (d.Results?.series?.[0]?.data || []).slice(0, lim);
                    return series.map(x => ({
                        title: `${name}: ${x.value}`, description: `Period: ${x.periodName} ${x.year}`,
                        date: `${x.year}-${x.period?.replace('M','')}-01`, link: 'https://www.bls.gov/data/', value: x.value
                    }));
                }
            } catch (e) {
                // Fall back to Flask backend if CORS fails
                try {
                    const r = await fetch(`${API_BASE}/api/bls?series=${sid}&start_year=${startYear}&end_year=${endYear}&limit=${lim}`);
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data || []).map(x => ({
                            title: `${name}: ${x.value}`, description: `Period: ${x.periodName} ${x.year}`,
                            date: `${x.year}-${x.period?.replace('M','')}-01`, link: 'https://www.bls.gov/data/', value: x.value
                        }));
                    }
                } catch (e2) { }
            }
            // Return empty with message if both fail
            return [{
                title: `${name}: Data Unavailable`,
                description: 'BLS API requires backend proxy. Run Flask backend for full access.',
                date: '', link: 'https://www.bls.gov/data/'
            }];
        }
    },
    census: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            if (sub === 'income') {
                const r = await fetch('https://api.census.gov/data/2022/acs/acs1?get=NAME,B19013_001E&for=state:*');
                const d = await r.json();
                return d.slice(1).sort((a,b)=>parseInt(b[1]||0)-parseInt(a[1]||0)).slice(0,lim).map(x => ({
                    title: x[0], description: x[1] && x[1]!=='-666666666' ? `Median Household Income: $${parseInt(x[1]).toLocaleString()}` : 'Data not available',
                    date: '2022 ACS', link: 'https://data.census.gov/'
                }));
            }
            const r = await fetch('https://api.census.gov/data/2022/acs/acs1?get=NAME,B01001_001E&for=state:*');
            const d = await r.json();
            return d.slice(1).sort((a,b)=>parseInt(b[1]||0)-parseInt(a[1]||0)).slice(0,lim).map(x => ({
                title: x[0], description: `Population (ACS 2022): ${parseInt(x[1]).toLocaleString()}`,
                date: '2022', link: 'https://data.census.gov/', population: x[1]
            }));
        }
    },
    fdic: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            if (sub === 'failures') {
                const r = await fetch(`https://banks.data.fdic.gov/api/failures?limit=${lim}&sort_by=FAILDATE&sort_order=DESC`);
                const d = await r.json();
                return (d.data || []).map(x => ({
                    title: x.data?.NAME || x.data?.INSTNAME || 'Unknown Bank',
                    description: `${x.data?.CITY || ''}, ${x.data?.STATE || ''} | Deposits: $${(x.data?.TOTALDEPOSITS||0).toLocaleString()} | Acquiring: ${x.data?.ACQUIRINGINSTITUTION || 'N/A'}`,
                    date: x.data?.FAILDATE || '', link: 'https://www.fdic.gov/resources/resolutions/bank-failures/'
                }));
            }
            const r = await fetch(`https://banks.data.fdic.gov/api/institutions?limit=${lim}&sort_by=ASSET&sort_order=DESC&filters=ACTIVE%3A1`);
            const d = await r.json();
            return (d.data || []).map(x => ({
                title: x.data?.INSTNAME || x.data?.REPNM || 'Unknown Institution',
                description: `${x.data?.CITY || ''}, ${x.data?.STNAME || ''} | Assets: $${(x.data?.ASSET||0).toLocaleString()}K | Class: ${x.data?.INSTCAT || x.data?.SPECGRP || 'N/A'}`,
                date: x.data?.REPDTE || x.data?.DATEUPDT || '', link: `https://www.fdic.gov/bank/individual/details/overview.html?newsFeedURL=/${x.data?.CERT || ''}`
            }));
        }
    },
    nih: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            if (sub === 'pubmed') {
                const q = query || 'health';
                try {
                    let dateFilter = '';
                    if (opts.dateFrom) dateFilter += `&mindate=${opts.dateFrom.replace(/-/g,'/')}&datetype=edat`;
                    if (opts.dateTo) dateFilter += `&maxdate=${opts.dateTo.replace(/-/g,'/')}`;
                    const r = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${q}&retmax=${lim}&retmode=json&sort=date${dateFilter}`, {signal: AbortSignal.timeout(5000)});
                    if (r.ok) {
                        const d = await r.json();
                        const ids = d.esearchresult?.idlist || [];
                        if (ids.length) {
                            const r2 = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`);
                            if (r2.ok) {
                                const d2 = await r2.json();
                                return ids.filter(id => d2.result?.[id]?.title).map(id => {
                                    const a = d2.result[id];
                                    return { title: a.title, description: `Authors: ${(a.authors||[]).slice(0,3).map(x=>x.name).join(', ')} | Journal: ${a.source||''}`,
                                        date: a.pubdate || '', link: `https://pubmed.ncbi.nlm.nih.gov/${id}/` };
                                });
                            }
                        }
                    }
                } catch (e) {
                    // Fall back to Flask proxy
                    try {
                        const r = await fetch(`${API_BASE}/api/nih/pubmed?q=${encodeURIComponent(q)}&limit=${lim}&date_min=${opts.dateFrom || ''}`);
                        if (r.ok) {
                            const d = await r.json();
                            const result = d.data || {};
                            return Object.values(result).filter(x => x.title).slice(0, lim).map(x => ({
                                title: x.title || '', description: (x.abstract || '').substring(0,300),
                                date: x.pubdate || '', link: `https://pubmed.ncbi.nlm.nih.gov/${x.uid}/`
                            }));
                        }
                    } catch (e2) { }
                }
                return [];
            }
            let url = `https://clinicaltrials.gov/api/v2/studies?pageSize=${lim}&sort=LastUpdatePostDate:desc`;
            if (query) url += `&query.term=${encodeURIComponent(query)}`;
            const r = await fetch(url);
            const d = await r.json();
            return (d.studies || []).map(s => ({
                title: s.protocolSection?.identificationModule?.briefTitle || '',
                description: (s.protocolSection?.descriptionModule?.briefSummary || '').substring(0,300),
                date: s.protocolSection?.statusModule?.lastUpdateSubmitDate || '',
                link: `https://clinicaltrials.gov/study/${s.protocolSection?.identificationModule?.nctId || ''}`,
                status: s.protocolSection?.statusModule?.overallStatus || ''
            }));
        }
    },
    fec: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const key = datagovKey || 'DEMO_KEY';
            if (sub === 'filings') {
                let dateFilter = '';
                if (opts.dateFrom) dateFilter += `&min_receipt_date=${opts.dateFrom}`;
                if (opts.dateTo) dateFilter += `&max_receipt_date=${opts.dateTo}`;
                const r = await fetch(`https://api.open.fec.gov/v1/filings/?api_key=${key}&per_page=${lim}&sort=-receipt_date${dateFilter}`);
                const d = await r.json();
                return (d.results || []).map(x => ({
                    title: x.committee_name || '', description: `Form: ${x.form_type||''} | Receipts: $${(x.total_receipts||0).toLocaleString()}`,
                    date: x.receipt_date || '', link: `https://www.fec.gov/data/committee/${x.committee_id||''}/`
                }));
            }
            const r = await fetch(`https://api.open.fec.gov/v1/candidates/?api_key=${key}&per_page=${lim}&election_year=2024&sort=-total_receipts`);
            const d = await r.json();
            return (d.results || []).map(x => ({
                title: x.name || '', description: `Party: ${x.party_full||''} | Office: ${x.office_full||''} | State: ${x.state||''}`,
                date: `Cycle: ${(x.election_years||[''])[0]}`, link: `https://www.fec.gov/data/candidate/${x.candidate_id||''}/`
            }));
        }
    },
    loc: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const q = query || 'government';
            try {
                const r = await fetch(`https://www.loc.gov/search/?q=${encodeURIComponent(q)}&fo=json&c=${lim}`, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    return (d.results || []).map(x => ({
                        title: x.title || (Array.isArray(x.description) ? x.description[0] : ''),
                        description: (Array.isArray(x.description) ? x.description[0] : (x.description || '')).substring(0,300),
                        date: x.date || '', link: x.url || x.id || ''
                    }));
                }
            } catch (e) {
                // Fall back to Flask proxy
                try {
                    const r = await fetch(`${API_BASE}/api/loc?q=${encodeURIComponent(q)}&limit=${lim}`);
                    if (r.ok) {
                        const d = await r.json();
                        const data = d.data || {};
                        return (data.results || []).map(x => ({
                            title: x.title || '', description: (x.description || '').substring(0,300),
                            date: x.date || '', link: x.url || ''
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'LOC Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.loc.gov/'}];
        }
    },
    usaspending: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            try {
                // Try direct API with proxy fallback
                const timePeriod = {start_date: opts.dateFrom || "2024-01-01", end_date: opts.dateTo || "2026-12-31"};
                const payload = query
                    ? {filters:{keywords:[query],time_period:[timePeriod]},fields:["Award ID","Recipient Name","Award Amount","Description","Start Date","Awarding Agency"],limit:lim, page:1, sort:"Award Amount", order:"desc"}
                    : {filters:{}, limit:lim, page:1, fields:["Award ID","Recipient Name","Award Amount","Description","Start Date","Awarding Agency"]};

                const r = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify(payload),
                    signal: AbortSignal.timeout(5000)
                });
                if (r.ok) {
                    const d = await r.json();
                    return (d.results||[]).slice(0,lim).map(x => ({
                        title: x['Recipient Name']||'Unknown', description: `Award: ${x['Award ID']||''} - ${(x.Description||'').substring(0,150)}`,
                        date: x['Start Date']||'', link: `https://www.usaspending.gov/award/${x.internal_id||''}`, amount: x['Award Amount']
                    }));
                }
            } catch (e) {
                // Fall back to Flask proxy
                try {
                    const r = await fetch(`${API_BASE}/api/usaspending?limit=${lim}`, {method:'POST'});
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data||[]).map(x => ({
                            title: x.recipient_name||'Unknown', description: `Amount: $${(x.federal_action_obligation||0).toLocaleString()}`,
                            date: x.action_date||'', link: 'https://www.usaspending.gov/'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'USAspending Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.usaspending.gov/'}];
        }
    },
    nist: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            let url = `https://services.nvd.nist.gov/rest/json/cves/2.0?resultsPerPage=${lim}`;
            if (opts.dateFrom) url += `&pubStartDate=${opts.dateFrom}T00:00:00.000`;
            if (opts.dateTo) url += `&pubEndDate=${opts.dateTo}T23:59:59.999`;
            if (query) url += `&keywordSearch=${encodeURIComponent(query)}`;
            const r = await fetch(url);
            const d = await r.json();
            return (d.vulnerabilities||[]).map(v => {
                const c = v.cve||{};
                const desc = (c.descriptions||[]).find(d=>d.lang==='en')?.value || '';
                let cvss = '';
                if (c.metrics?.cvssMetricV31?.[0]) cvss = c.metrics.cvssMetricV31[0].cvssData?.baseScore||'';
                return { title: c.id||'', description: desc.substring(0,300), date: c.published||'',
                    link: `https://nvd.nist.gov/vuln/detail/${c.id||''}`, cvss_score: cvss };
            });
        }
    },
    fcc: {
        fetch: async (sub, query, opts = {}) => {
            // FCC ID Search — the main lookup
            if (sub === 'equipment_auth' || (!sub && query)) {
                return await fccEquipmentSearch(query, opts);
            }
            // ECFS filings
            if (sub === 'ecfs_filings') {
                return await fccEcfsFilings(query, opts);
            }
            // Consumer complaints via Socrata
            if (sub === 'complaints') {
                return await fccComplaints(query, opts);
            }
            // Broadband providers
            if (sub === 'broadband') {
                return await fccBroadband(opts);
            }
            // Default: equipment auth
            return await fccEquipmentSearch(query, opts);
        }
    },
    doj: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            try {
                // DOJ data via Flask backend (direct API unreliable)
                const r = await fetch(`${API_BASE}/api/doj?limit=${lim}`, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    if (d.status === 'success' && d.data && d.data.length > 0) {
                        return (d.data || []).map(x => ({
                            title: x.title || x.name || 'DOJ Record',
                            description: (x.description || x.excerpt || '').substring(0,300),
                            date: x.date || x.publish_date || '',
                            link: x.url || x.link || 'https://www.justice.gov/'
                        }));
                    }
                }
            } catch (e) {
                // Fall back to direct API as secondary option
                try {
                    const r = await fetch(`https://data.gov/api/catalogs`, {signal: AbortSignal.timeout(3000)});
                    if (r.ok) {
                        // If data.gov API works, return placeholder
                        return [{title: 'DOJ Records', description: 'Available via Flask backend', date: '', link: 'https://www.justice.gov/'}];
                    }
                } catch (e2) { }
            }
            return [{title: 'DOJ Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.justice.gov/'}];
        }
    },
    dot: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            try {
                // Try Flask backend first (NHTSA API has strict access controls)
                const endpoint = sub === 'complaints' ? 'complaints' : 'recalls';
                const r = await fetch(`${API_BASE}/api/dot/${endpoint}?limit=${lim}`, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    if (d.status === 'success' && d.data && d.data.length > 0) {
                        return (d.data || []).map(x => ({
                            title: x.title || x.component || 'DOT Record',
                            description: (x.description || x.summary || '').substring(0,300),
                            date: x.date || x.report_date || '', link: x.link || 'https://www.nhtsa.gov/'
                        }));
                    }
                }

                // Fallback: try direct API (may be blocked)
                if (sub === 'complaints' || (!sub && query)) {
                    const url = `https://api.nhtsa.gov/complaints?pagesize=${lim}&format=json`;
                    const r2 = await fetch(url, {signal: AbortSignal.timeout(3000)});
                    if (r2.ok) {
                        const d = await r2.json();
                        return (d.results || []).map(x => ({
                            title: x.complaint_text?.substring(0,80) || 'Safety Complaint',
                            description: `${x.vehicle_make} ${x.vehicle_year} | ${(x.complaint_text || '').substring(0,200)}`,
                            date: x.complaint_date || '', link: 'https://www.nhtsa.gov/'
                        }));
                    }
                } else {
                    const url = `https://api.nhtsa.gov/recalls/recallsearch?pageindex=0&resultsperpage=${lim}&format=json`;
                    const r2 = await fetch(url, {signal: AbortSignal.timeout(3000)});
                    if (r2.ok) {
                        const d = await r2.json();
                        return (d.results || []).map(x => ({
                            title: `${x.Make} ${x.ModelYear} - ${x.Component}`,
                            description: (x.Summary || '').substring(0,300),
                            date: x.ReportReceivedDate || '', link: 'https://www.nhtsa.gov/recalls'
                        }));
                    }
                }
            } catch (e) {
                // Final fallback
                try {
                    const endpoint = sub === 'complaints' ? 'complaints' : 'recalls';
                    const r = await fetch(`${API_BASE}/api/dot/${endpoint}?limit=${lim}`);
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data || []).map(x => ({
                            title: x.title || '', description: x.description || '',
                            date: x.date || '', link: 'https://www.nhtsa.gov/'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'DOT Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.nhtsa.gov/'}];
        }
    },
    epa: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            try {
                // EPA data primarily via Flask backend for reliability
                const r = await fetch(`${API_BASE}/api/epa?sub=${sub || 'tri'}&limit=${lim}`, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    if (d.status === 'success' && d.data && d.data.length > 0) {
                        return (d.data || []).map(x => ({
                            title: x.name || x.facility_name || 'EPA Record',
                            description: (x.description || x.location || '').substring(0,300),
                            date: x.date || x.last_update || '', link: 'https://www.epa.gov/'
                        }));
                    }
                }
            } catch (e) {
                // Fall back to direct Envirofacts API as secondary
                try {
                    let url = 'https://data.epa.gov/api/3/action/datastore_search?resource_id=';
                    const resourceId = sub === 'water' ? 'water-system-id' : 'tri-data-id';
                    const r = await fetch(`${url}${resourceId}&limit=${lim}`, {signal: AbortSignal.timeout(3000)});
                    if (r.ok) {
                        const d = await r.json();
                        return (d.result?.records || []).map(x => ({
                            title: x.name || 'EPA Record',
                            description: (x.description || '').substring(0,300),
                            date: x.date || '', link: 'https://www.epa.gov/'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'EPA Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.epa.gov/'}];
        }
    },
    sam: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const key = datagovKey || 'DEMO_KEY';
            try {
                const url = `https://api.sam.gov/opportunities/v2/search?api_key=${key}&pagesize=${lim}&keyword=${query || ''}`;
                const r = await fetch(url, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    return (d.opportunitiesData || []).slice(0, lim).map(x => ({
                        title: x.title || 'Contract Opportunity',
                        description: (x.description || '').substring(0,300),
                        date: x.postedDate || '', link: x.url || 'https://sam.gov'
                    }));
                }
            } catch (e) {
                // Fall back to proxy
                try {
                    const r = await fetch(`${API_BASE}/api/sam?key=${key}&limit=${lim}&q=${encodeURIComponent(query || '')}`);
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data || []).map(x => ({
                            title: x.title || '', description: x.description || '',
                            date: x.date || '', link: x.url || 'https://sam.gov'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'SAM.gov requires API key', description: 'Get free key at api.sam.gov', date: '', link: 'https://sam.gov'}];
        }
    },
    ftc: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            try {
                // FTC ReportPortal API
                const url = `https://reportportal.ftc.gov/api/widget/data?pagesize=${lim}`;
                const r = await fetch(url, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    const reports = Array.isArray(d) ? d : (d.data || d.reports || []);
                    return reports.slice(0, lim).map(x => ({
                        title: x.report_type || x.title || 'FTC Report',
                        description: (x.description || x.summary || '').substring(0,300),
                        date: x.date_reported || x.date || '', link: 'https://reportportal.ftc.gov/'
                    }));
                }
            } catch (e) {
                // Fall back to proxy
                try {
                    const r = await fetch(`${API_BASE}/api/ftc?limit=${lim}`);
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data || []).map(x => ({
                            title: x.title || '', description: x.description || '',
                            date: x.date || '', link: x.url || 'https://www.ftc.gov/'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'FTC Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://www.ftc.gov/'}];
        }
    },
    nara: {
        fetch: async (sub, query, opts = {}) => {
            const lim = opts.limit || 20;
            const q = query || 'federal government';
            try {
                const url = `https://catalog.archives.gov/api/v2/records?q=${encodeURIComponent(q)}&pageSize=${lim}`;
                const r = await fetch(url, {signal: AbortSignal.timeout(5000)});
                if (r.ok) {
                    const d = await r.json();
                    return (d.records || []).map(x => ({
                        title: x.title || 'Archive Record',
                        description: (x.scopeAndContent || x.description || '').substring(0,300),
                        date: x.dateCreated || x.date || '', link: x.url || 'https://catalog.archives.gov/'
                    }));
                }
            } catch (e) {
                // Fall back to proxy
                try {
                    const r = await fetch(`${API_BASE}/api/nara?q=${encodeURIComponent(q)}&limit=${lim}`);
                    if (r.ok) {
                        const d = await r.json();
                        return (d.data || []).map(x => ({
                            title: x.title || '', description: x.description || '',
                            date: x.date || '', link: x.url || 'https://catalog.archives.gov/'
                        }));
                    }
                } catch (e2) { }
            }
            return [{title: 'NARA Data Unavailable', description: 'Run Flask backend for full access', date: '', link: 'https://catalog.archives.gov/'}];
        }
    }
};

// ========== FCC API IMPLEMENTATIONS ==========

async function fccEquipmentSearch(query, opts = {}) {
    const lim = opts.limit || 25;
    // FCC Equipment Authorization System
    // No query: show recent equipment grants as cards
    if (!query) {
        try {
            let dateFilter = '';
            if (opts.dateFrom) dateFilter += ` AND grant_date >= '${opts.dateFrom}'`;
            if (opts.dateTo) dateFilter += ` AND grant_date <= '${opts.dateTo}'`;
            const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=${lim}&$order=grant_date DESC${dateFilter ? '&$where=1=1' + encodeURIComponent(dateFilter) : ''}`);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) {
                return d.map(x => ({
                    title: x.equipment_product_description || x.product_description || x.applicant_name || 'Unknown Device',
                    description: `Applicant: ${x.applicant_name || x.grantee_name || 'N/A'} | FCC ID: ${(x.grantee_code||'') + (x.product_code||'')}`,
                    date: x.grant_date || x.date_of_grant || '',
                    link: `https://apps.fcc.gov/oetcf/eas/reports/ViewExhibitReport.cfm?mode=Exhibits&RequestTimeout=500&calledFromFrame=N&fcc_id=${(x.grantee_code||'') + (x.product_code||'')}`,
                    fcc_id: (x.grantee_code||'') + (x.product_code||''),
                    applicant: x.applicant_name || x.grantee_name || '',
                    grantee_code: x.grantee_code || '',
                    product_code: x.product_code || ''
                }));
            }
        } catch(e) { /* fall through */ }
        try {
            const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=${lim}&$order=:id DESC`);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) {
                return d.map(x => ({
                    title: x.grantee_name || x.applicant_name || 'Unknown',
                    description: `Grantee Code: ${x.grantee_code || 'N/A'} | ${[x.physical_city, x.physical_state].filter(Boolean).join(', ')}`,
                    date: x.last_update_date || '',
                    link: '',
                    grantee_code: x.grantee_code || '',
                    grantee_name: x.grantee_name || ''
                }));
            }
        } catch(e) { /* fall through */ }
        return [{ title: 'Equipment Authorizations', description: 'Search by FCC ID (e.g. 2ABCB-1234), grantee code, or company name', date: '' }];
    }

    // === SEARCH MODE: return rich detail results flagged for special rendering ===
    const q = query.trim().toUpperCase();
    let granteeCode = '', productCode = '';

    // Parse FCC ID format — only recognize clear FCC ID patterns:
    //   "ABC-1234" (with hyphen = definitely FCC ID)
    //   "2ABCB" (3-5 alphanum = likely grantee code)
    if (q.includes('-') && /^[A-Z0-9]{3,5}-[A-Z0-9]+$/i.test(q)) {
        // Definitely an FCC ID: GRANTEE-PRODUCT
        const parts = q.split('-');
        granteeCode = parts[0];
        productCode = parts.slice(1).join('-');
    } else if (/^[A-Z0-9]{3,5}$/.test(q)) {
        // 3-5 char alphanumeric = likely a grantee code
        granteeCode = q;
    }
    // Anything else (longer strings, spaces, etc.) = treated as company name search

    // Collect ALL raw data from multiple sources, then merge
    let equipmentData = []; // from equipment auth dataset
    let granteeInfo = null;  // from grantee registration dataset

    // 1) Equipment authorization records (only if we have a grantee code)
    if (granteeCode) {
        try {
            let url = `https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=${lim}&$where=grantee_code='${granteeCode}'`;
            if (productCode) url += ` AND product_code='${productCode}'`;
            const r = await corsFetch(url);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) equipmentData = d;
        } catch(e) { console.log('Equipment data fetch failed:', e); }
    }

    // 2) Grantee registration info (only if we have a grantee code)
    if (granteeCode) {
        try {
            const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=1&$where=grantee_code='${granteeCode}'`);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) granteeInfo = d[0];
        } catch(e) { console.log('Grantee info fetch failed:', e); }
    }

    // 3) If no grantee code OR grantee code found nothing — do a name search
    if (!granteeCode || (equipmentData.length === 0 && !granteeInfo)) {
        const nameResults = await fccNameSearch(q);
        if (nameResults && nameResults.length > 0) {
            // If we originally had a grantee code that found nothing, this is a name fallback
            return nameResults;
        }
    }

    // 4) Fallback: try HTML scrape of EAS
    if (equipmentData.length === 0 && granteeCode) {
        try {
            const searchUrl = `https://apps.fcc.gov/oetcf/eas/reports/GenericSearchResult.cfm?RequestTimeout=500&calledFromFrame=Y&grantee_code=${granteeCode}&product_code=${productCode || ''}`;
            const r = await corsFetch(searchUrl);
            const html = await r.text();
            const rows = html.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
            for (const row of rows.slice(1, 30)) {
                const cells = row.match(/<td[^>]*>([\s\S]*?)<\/td>/gi) || [];
                if (cells.length >= 4) {
                    const clean = s => s.replace(/<[^>]*>/g,'').trim();
                    const id = clean(cells[0]||'');
                    const app = clean(cells[1]||'');
                    const desc = clean(cells[2]||'');
                    const gdate = clean(cells[3]||'');
                    if (id || app) {
                        const gc = id.substring(0, Math.min(5, id.length));
                        const pc = id.substring(Math.min(5, id.length));
                        equipmentData.push({
                            grantee_code: gc, product_code: pc,
                            applicant_name: app,
                            equipment_product_description: desc,
                            grant_date: gdate
                        });
                    }
                }
            }
        } catch(e) { console.log('EAS HTML parse failed:', e); }
    }

    if (equipmentData.length === 0 && !granteeInfo) {
        return [{ title: `No FCC results for "${query}"`, description: 'Try an FCC ID (e.g. 2ABCB-1234), grantee code (e.g. BCG), or company name (e.g. Samsung)', date: '' }];
    }

    // Build the special FCC detail result set
    // First item is a meta-marker telling renderData to use FCC detail view
    const results = [];
    results.push({
        _fcc_detail_view: true,
        _query: query,
        _grantee_code: granteeCode,
        _product_code: productCode,
        _grantee_info: granteeInfo,
        _equipment: equipmentData,
        title: `FCC Search: ${query}`,
        description: `${equipmentData.length} equipment record(s) found`,
        date: ''
    });
    return results;
}

async function fccNameSearch(q) {
    // Search grantee registrations by company name
    // Try multiple search strategies in order
    const results = [];

    // Strategy A: Socrata $q full-text search (most flexible)
    try {
        const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=30&$q=${encodeURIComponent(q)}`);
        const d = await r.json();
        if (Array.isArray(d) && d.length > 0) {
            for (const x of d) {
                results.push({
                    title: x.grantee_name || 'Unknown',
                    description: `Grantee Code: ${x.grantee_code || ''} | ${[x.physical_city, x.physical_state, x.physical_country_code].filter(Boolean).join(', ')}`,
                    date: x.last_update_date || '',
                    link: '',
                    grantee_code: x.grantee_code || '',
                    grantee_name: x.grantee_name || '',
                    _fcc_grantee_click: true
                });
            }
        }
    } catch(e) { console.log('FCC name $q search failed:', e); }

    // Strategy B: LIKE search on grantee_name if $q returned nothing
    if (results.length === 0) {
        try {
            const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=30&$where=upper(grantee_name) like '%25${encodeURIComponent(q)}%25'`);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) {
                for (const x of d) {
                    results.push({
                        title: x.grantee_name || 'Unknown',
                        description: `Grantee Code: ${x.grantee_code || ''} | ${[x.physical_city, x.physical_state, x.physical_country_code].filter(Boolean).join(', ')}`,
                        date: x.last_update_date || '',
                        link: '',
                        grantee_code: x.grantee_code || '',
                        grantee_name: x.grantee_name || '',
                        _fcc_grantee_click: true
                    });
                }
            }
        } catch(e) { console.log('FCC name LIKE search failed:', e); }
    }

    // Strategy C: Also search the equipment dataset applicant_name
    if (results.length === 0) {
        try {
            const r = await corsFetch(`https://opendata.fcc.gov/resource/3b3k-34jp.json?$limit=30&$q=${encodeURIComponent(q)}`);
            const d = await r.json();
            if (Array.isArray(d) && d.length > 0) {
                // Deduplicate by grantee_code
                const seen = new Set();
                for (const x of d) {
                    const gc = x.grantee_code || '';
                    if (gc && !seen.has(gc)) {
                        seen.add(gc);
                        results.push({
                            title: x.applicant_name || x.equipment_product_description || 'Unknown',
                            description: `Grantee Code: ${gc} | Product: ${x.equipment_product_description || ''}`,
                            date: x.grant_date || '',
                            link: '',
                            grantee_code: gc,
                            grantee_name: x.applicant_name || '',
                            _fcc_grantee_click: true
                        });
                    }
                }
            }
        } catch(e) { console.log('FCC equipment name search failed:', e); }
    }

    // Strategy D: HTML scrape the FCC EAS search by applicant name
    if (results.length === 0) {
        try {
            const searchUrl = `https://apps.fcc.gov/oetcf/eas/reports/GenericSearchResult.cfm?RequestTimeout=500&calledFromFrame=Y&applicant_name=${encodeURIComponent(q)}`;
            const r = await corsFetch(searchUrl);
            const html = await r.text();
            const rows = html.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
            const seen = new Set();
            for (const row of rows.slice(1, 30)) {
                const cells = row.match(/<td[^>]*>([\s\S]*?)<\/td>/gi) || [];
                if (cells.length >= 2) {
                    const clean = s => s.replace(/<[^>]*>/g,'').trim();
                    const fccId = clean(cells[0]||'');
                    const applicant = clean(cells[1]||'');
                    const gc = fccId.substring(0, Math.min(5, fccId.length));
                    if (gc && !seen.has(gc)) {
                        seen.add(gc);
                        results.push({
                            title: applicant || 'Unknown',
                            description: `Grantee Code: ${gc} | FCC ID: ${fccId}`,
                            date: '',
                            link: '',
                            grantee_code: gc,
                            grantee_name: applicant || '',
                            _fcc_grantee_click: true
                        });
                    }
                }
            }
        } catch(e) { console.log('EAS HTML name search failed:', e); }
    }

    return results;
}

async function fccEcfsFilings(query, opts = {}) {
    const lim = opts.limit || 25;
    // FCC Electronic Comment Filing System
    let url = `https://publicapi.fcc.gov/ecfs/filings?limit=${lim}&sort=date_received,DESC`;
    if (query) url += `&q=${encodeURIComponent(query)}`;
    try {
        const r = await corsFetch(url);
        const d = await r.json();
        const filings = d.filings || d.results || d || [];
        if (Array.isArray(filings) && filings.length > 0) {
            return filings.map(f => ({
                title: f.name_of_filer || f.filer || f.submitter || 'Anonymous Filer',
                description: `Proceeding: ${f.proceedings?.[0]?.name || f.proceeding || 'N/A'} | Type: ${f.type_of_filing || f.filing_type || ''}${f.text_data ? ' | ' + (f.text_data || '').substring(0,150) : ''}`,
                date: f.date_received || f.date_submission || f.date_posted || '',
                link: f.id_submission ? `https://www.fcc.gov/ecfs/document/${f.id_submission}/1` : 'https://www.fcc.gov/ecfs/',
                proceeding_number: f.proceedings?.[0]?.id || f.proceeding_number || '',
                bureau: f.bureau || ''
            }));
        }
    } catch(e) { console.log('ECFS filings failed:', e); }

    // Fallback: try alternate format
    try {
        const r = await corsFetch(`https://publicapi.fcc.gov/ecfs/filings?limit=${lim}&sort=date_received,DESC`);
        const text = await r.text();
        const d = JSON.parse(text);
        if (d && typeof d === 'object') {
            const items = d.filings || d.results || (Array.isArray(d) ? d : []);
            return items.slice(0, lim).map(f => ({
                title: f.name_of_filer || JSON.stringify(f).substring(0, 80),
                description: 'ECFS Filing',
                date: f.date_received || '',
                link: 'https://www.fcc.gov/ecfs/'
            }));
        }
    } catch(e) { /* fall through */ }

    return [{ title: 'ECFS Filings', description: 'Unable to load filings. The FCC ECFS API may be temporarily unavailable. Visit the link to browse filings directly.', date: '', link: 'https://www.fcc.gov/ecfs/' }];
}

async function fccComplaints(query, opts = {}) {
    const lim = opts.limit || 25;
    // FCC Consumer Complaints via Socrata
    let dateFilter = '';
    if (opts.dateFrom) dateFilter += ` AND ticket_created >= '${opts.dateFrom}'`;
    if (opts.dateTo) dateFilter += ` AND ticket_created <= '${opts.dateTo}'`;
    let url = `https://opendata.fcc.gov/resource/3xyp-aqkj.json?$limit=${lim}&$order=ticket_created DESC${dateFilter ? '&$where=1=1' + encodeURIComponent(dateFilter) : ''}`;
    if (query) url += `&$where=upper(issue) like '%25${encodeURIComponent(query.toUpperCase())}%25' OR upper(method) like '%25${encodeURIComponent(query.toUpperCase())}%25'`;
    try {
        const r = await corsFetch(url);
        const d = await r.json();
        if (Array.isArray(d) && d.length > 0) {
            return d.map(x => ({
                title: x.issue || x.issue_type || x.type_of_issue || 'Complaint',
                description: `Method: ${x.method || 'N/A'} | Status: ${x.status || 'N/A'} | ${x.city ? x.city + ', ' : ''}${x.state || ''}`,
                date: x.ticket_created || x.date_created || x.date_of_issue || '',
                link: 'https://opendata.fcc.gov/Consumer/CGB-Consumer-Complaints-Data/3xyp-aqkj',
                issue: x.issue || '',
                method: x.method || '',
                status: x.status || '',
                state: x.state || ''
            }));
        }
    } catch(e) { console.log('FCC complaints failed:', e); }

    // Alternate complaint dataset
    try {
        const r = await corsFetch('https://opendata.fcc.gov/resource/sr6c-syda.json?$limit=25&$order=:id DESC');
        const d = await r.json();
        if (Array.isArray(d) && d.length > 0) {
            return d.map(x => ({
                title: x.type_of_issue || x.issue || Object.values(x)[0] || 'Complaint',
                description: Object.entries(x).filter(([k]) => !['type_of_issue','issue'].includes(k)).map(([k,v]) => `${k}: ${v}`).slice(0,3).join(' | '),
                date: x.date || '',
                link: 'https://opendata.fcc.gov/'
            }));
        }
    } catch(e) { /* fall through */ }

    return [{ title: 'Consumer Complaints', description: 'Unable to load FCC complaint data. Try visiting the link directly.', date: '', link: 'https://opendata.fcc.gov/Consumer/CGB-Consumer-Complaints-Data/3xyp-aqkj' }];
}

async function fccBroadband(opts = {}) {
    const lim = opts.limit || 30;
    // Mobile broadband carrier data
    try {
        const r = await corsFetch('https://broadbandmap.fcc.gov/api/public/map/listMobileProviders');
        const d = await r.json();
        const providers = d.data || d.providers || d || [];
        if (Array.isArray(providers) && providers.length > 0) {
            return providers.slice(0, lim).map(p => ({
                title: p.provider_name || p.holding_company_name || p.dba_name || p.name || 'Provider',
                description: `Provider ID: ${p.provider_id || p.frn || 'N/A'} | Technology: ${p.technology_desc || p.technology || 'Various'}`,
                date: '',
                link: 'https://broadbandmap.fcc.gov/',
                provider_id: p.provider_id || p.frn || '',
                technology: p.technology_desc || p.technology || ''
            }));
        }
    } catch(e) { console.log('Broadband map API failed:', e); }

    // Fallback: FCC broadband Socrata dataset
    try {
        const r = await corsFetch('https://opendata.fcc.gov/resource/sgz3-kiqt.json?$limit=25');
        const d = await r.json();
        if (Array.isArray(d) && d.length > 0) {
            return d.map(x => ({
                title: x.provider_name || x.holding_company || Object.values(x)[0] || 'Provider',
                description: Object.entries(x).filter(([k]) => k !== 'provider_name').map(([k,v]) => `${k}: ${v}`).slice(0,3).join(' | '),
                date: '',
                link: 'https://broadbandmap.fcc.gov/'
            }));
        }
    } catch(e) { /* fall through */ }

    return [{ title: 'Broadband Providers', description: 'Unable to load broadband data. The FCC Broadband Map API may require updated endpoints. Visit the link directly.', date: '', link: 'https://broadbandmap.fcc.gov/' }];
}

// Fallback agency metadata for client-side mode
const CLIENT_AGENCIES = [
    {id:'sec',name:'Securities and Exchange Commission',acronym:'SEC',description:'Corporate filings, financial disclosures, and securities data from EDGAR',
     base_url:'https://data.sec.gov',auth_required:false,has_search:true,search_placeholder:'Search company name or CIK...',
     data_categories:['Financial','Corporate','Securities','Compliance'],
     sub_sections:[{id:'8-K',name:'8-K Current Reports'},{id:'10-K',name:'10-K Annual Reports'},{id:'10-Q',name:'10-Q Quarterly'},{id:'13F',name:'13F Holdings'},{id:'S-1',name:'S-1 IPO Filings'}],
     endpoints:['8-K','10-K','10-Q','13F','S-1','Company Search']},
    {id:'fda',name:'Food and Drug Administration',acronym:'FDA',description:'Drug adverse events, recalls, 510(k) device clearances, and food safety data',
     base_url:'https://api.fda.gov',auth_required:false,has_search:true,search_placeholder:'Search drug name, device, or keyword...',
     data_categories:['Health','Safety','Medical Devices','Pharmaceuticals'],
     sub_sections:[{id:'drug_events',name:'Drug Adverse Events'},{id:'drug_recalls',name:'Drug Recalls'},{id:'device_510k',name:'Device 510(k) Clearances'},{id:'device_recalls',name:'Device Recalls'},{id:'food_recalls',name:'Food Recalls'}],
     endpoints:['Drug Events','Drug Recalls','510(k)','Device Recalls','Food Recalls']},
    {id:'treasury',name:'US Treasury',acronym:'Treasury',description:'Federal debt, daily treasury statements, interest rates, and exchange rates',
     base_url:'https://api.fiscaldata.treasury.gov',auth_required:false,has_search:false,
     data_categories:['Financial','Economic','Fiscal Policy'],
     sub_sections:[{id:'national_debt',name:'National Debt'},{id:'daily_statements',name:'Daily Treasury Statements'},{id:'interest_rates',name:'Average Interest Rates'},{id:'exchange_rates',name:'Exchange Rates'}],
     endpoints:['National Debt','Daily Statements','Interest Rates','Exchange Rates']},
    {id:'usaspending',name:'USAspending.gov',acronym:'USAspending',description:'Federal spending, contracts, grants, and budget data across all agencies',
     base_url:'https://api.usaspending.gov',auth_required:false,has_search:true,search_placeholder:'Search contracts, grants, recipients...',
     data_categories:['Financial','Contracts','Grants','Federal Spending'],
     sub_sections:[{id:'top_agencies',name:'Top Agencies by Budget'},{id:'federal_accounts',name:'Federal Accounts'}],
     endpoints:['Top Agencies','Federal Accounts','Award Search']},
    {id:'noaa',name:'National Oceanic and Atmospheric Administration',acronym:'NOAA',description:'Weather alerts, forecasts, and climate data from the National Weather Service',
     base_url:'https://api.weather.gov',auth_required:false,has_search:false,
     data_categories:['Weather','Climate','Environmental'],
     sub_sections:[{id:'alerts',name:'Active Weather Alerts'},{id:'forecast',name:'Weather Forecast (DC)'}],
     endpoints:['Weather Alerts','Forecast']},
    {id:'usgs',name:'United States Geological Survey',acronym:'USGS',description:'Earthquake data, water monitoring, and geological information',
     base_url:'https://earthquake.usgs.gov',auth_required:false,has_search:false,
     data_categories:['Geological','Environmental','Natural Hazards'],
     sub_sections:[{id:'earthquakes',name:'Recent Earthquakes'},{id:'water',name:'Water Monitoring'}],
     endpoints:['Earthquakes','Water Data']},
    {id:'nasa',name:'National Aeronautics and Space Administration',acronym:'NASA',description:'Astronomy pictures, near-earth objects, Mars rover photos',
     base_url:'https://api.nasa.gov',auth_required:false,has_search:false,
     data_categories:['Space','Science','Imagery'],
     sub_sections:[{id:'apod',name:'Astronomy Picture of the Day'},{id:'neo',name:'Near Earth Objects'},{id:'mars',name:'Mars Rover Photos'}],
     endpoints:['APOD','NEO','Mars Photos']},
    {id:'bls',name:'Bureau of Labor Statistics',acronym:'BLS',description:'Employment, unemployment, CPI, wages, and labor market data',
     base_url:'https://api.bls.gov',auth_required:false,has_search:false,
     data_categories:['Economic','Employment','Labor'],
     sub_sections:[{id:'unemployment',name:'Unemployment Rate'},{id:'cpi',name:'Consumer Price Index'},{id:'employment',name:'Total Nonfarm Employment'},{id:'avg_hourly_earnings',name:'Average Hourly Earnings'}],
     endpoints:['Unemployment','CPI','Employment','Wages']},
    {id:'census',name:'US Census Bureau',acronym:'Census',description:'Population estimates, demographics, and income data',
     base_url:'https://api.census.gov',auth_required:false,has_search:false,
     data_categories:['Demographics','Economic','Population'],
     sub_sections:[{id:'population',name:'Population by State'},{id:'income',name:'Median Income by State'}],
     endpoints:['Population','Income']},
    {id:'doj',name:'Department of Justice',acronym:'DOJ',description:'Press releases, news, speeches, and blog posts from the DOJ',
     base_url:'https://www.justice.gov/api/v1',auth_required:false,has_search:false,
     data_categories:['Legal','Law Enforcement','Policy'],
     sub_sections:[{id:'press_releases',name:'Press Releases'},{id:'blog_posts',name:'Blog Posts'},{id:'speeches',name:'Speeches'},{id:'news',name:'News'}],
     endpoints:['Press Releases','Blog Posts','Speeches','News']},
    {id:'fcc',name:'Federal Communications Commission',acronym:'FCC',description:'Equipment authorizations (FCC ID), ECFS filings, broadband data, and consumer complaints',
     base_url:'https://apps.fcc.gov',auth_required:false,has_search:true,search_placeholder:'Search FCC ID (e.g. 2ABCB), company name, or keyword...',
     data_categories:['Communications','Broadband','Spectrum'],
     sub_sections:[{id:'equipment_auth',name:'Equipment Authorizations'},{id:'ecfs_filings',name:'ECFS Filings'},{id:'complaints',name:'Consumer Complaints'},{id:'broadband',name:'Broadband Providers'}],
     endpoints:['Equipment Auth (FCC ID)','ECFS Filings','Complaints','Broadband']},
    {id:'ftc',name:'Federal Trade Commission',acronym:'FTC',description:'Consumer protection, antitrust enforcement, press releases and cases',
     base_url:'https://www.ftc.gov/api',auth_required:false,has_search:false,
     data_categories:['Consumer Protection','Antitrust','Privacy'],
     sub_sections:[{id:'press_releases',name:'Press Releases'},{id:'cases',name:'Enforcement Cases'}],
     endpoints:['Press Releases','Cases']},
    {id:'nist',name:'National Institute of Standards and Technology',acronym:'NIST',description:'National Vulnerability Database - CVE records and cybersecurity data',
     base_url:'https://services.nvd.nist.gov',auth_required:false,has_search:true,search_placeholder:'Search CVEs by keyword...',
     data_categories:['Cybersecurity','Vulnerabilities','Compliance'],
     sub_sections:[{id:'recent_cves',name:'Recent Vulnerabilities'}],
     endpoints:['Recent CVEs','CVE Search']},
    {id:'fec',name:'Federal Election Commission',acronym:'FEC',description:'Campaign finance data, candidate filings, and political committee information',
     base_url:'https://api.open.fec.gov',auth_required:false,has_search:false,
     data_categories:['Elections','Campaign Finance','Political'],
     sub_sections:[{id:'candidates',name:'Candidates (2024)'},{id:'filings',name:'Committee Filings'}],
     endpoints:['Candidates','Filings']},
    {id:'fdic',name:'Federal Deposit Insurance Corporation',acronym:'FDIC',description:'Bank financial data, institution information, and bank failure records',
     base_url:'https://banks.data.fdic.gov/api',auth_required:false,has_search:false,
     data_categories:['Financial','Banking','Regulatory'],
     sub_sections:[{id:'institutions',name:'Financial Institutions'},{id:'failures',name:'Bank Failures'}],
     endpoints:['Institutions','Failures']},
    {id:'nih',name:'National Institutes of Health',acronym:'NIH',description:'Clinical trials, PubMed research articles, and biomedical data',
     base_url:'https://clinicaltrials.gov/api',auth_required:false,has_search:true,search_placeholder:'Search clinical trials or research...',
     data_categories:['Health','Medical Research','Clinical Trials'],
     sub_sections:[{id:'clinical_trials',name:'Clinical Trials'},{id:'pubmed',name:'PubMed Research'}],
     endpoints:['Clinical Trials','PubMed']},
    {id:'loc',name:'Library of Congress',acronym:'LOC',description:'Digital collections, historical records, and the national library catalog',
     base_url:'https://www.loc.gov',auth_required:false,has_search:true,search_placeholder:'Search Library of Congress collections...',
     data_categories:['Historical','Cultural','Archives'],
     sub_sections:[{id:'collections',name:'Digital Collections'}],
     endpoints:['Collections']},
    {id:'nara',name:'National Archives',acronym:'NARA',description:'Historical federal records, documents, and archival materials',
     base_url:'https://catalog.archives.gov/api/v2',auth_required:false,has_search:true,search_placeholder:'Search historical records...',
     data_categories:['Historical','Archives','Government Records'],
     sub_sections:[{id:'records',name:'Archival Records'}],
     endpoints:['Records']},
    {id:'dot',name:'Department of Transportation',acronym:'DOT',description:'Vehicle recalls, safety complaints, and transportation safety data via NHTSA',
     base_url:'https://api.nhtsa.gov',auth_required:false,has_search:false,
     data_categories:['Transportation','Safety','Vehicle Recalls'],
     sub_sections:[{id:'recalls',name:'Vehicle Recalls'},{id:'complaints',name:'Safety Complaints'}],
     endpoints:['Recalls','Complaints']},
    {id:'sam',name:'System for Award Management',acronym:'SAM.gov',description:'Federal contract opportunities, entity registrations, procurement data',
     base_url:'https://api.sam.gov',auth_required:true,has_search:true,search_placeholder:'Search contract opportunities...',
     data_categories:['Contracts','Procurement','Federal Spending'],
     sub_sections:[{id:'opportunities',name:'Contract Opportunities'}],
     endpoints:['Opportunities']},
    {id:'epa',name:'Environmental Protection Agency',acronym:'EPA',description:'Environmental data including water systems, facilities, and toxic releases',
     base_url:'https://data.epa.gov',auth_required:false,has_search:false,
     data_categories:['Environmental','Health','Compliance'],
     sub_sections:[{id:'water_systems',name:'Water Systems'},{id:'facilities',name:'Regulated Facilities'},{id:'toxic_releases',name:'Toxic Release Inventory'}],
     endpoints:['Water Systems','Facilities','Toxic Releases']},
].filter(a => !a.skip);

// Init
async function init() {
    // Try Flask backend first, fallback to client-side
    try {
        const resp = await fetch(`${API_BASE}/api/agencies`, {signal: AbortSignal.timeout(3000)});
        if (resp.ok) {
            agencies = await resp.json();
        } else {
            throw new Error('Backend returned error');
        }
    } catch (e) {
        console.log('Flask backend unavailable, using client-side direct API mode');
        useDirectApi = true;
        agencies = CLIENT_AGENCIES;
    }
    // Load API keys from localStorage
    try {
        if (localStorage.getItem('openai_key')) openaiKey = localStorage.getItem('openai_key');
        if (localStorage.getItem('groq_key')) groqKey = localStorage.getItem('groq_key');
        if (localStorage.getItem('gemini_key')) geminiKey = localStorage.getItem('gemini_key');
        if (localStorage.getItem('claude_key')) claudeKey = localStorage.getItem('claude_key');
        if (localStorage.getItem('datagov_key')) datagovKey = localStorage.getItem('datagov_key');
        // Also restore which provider was last used
        if (localStorage.getItem('ai_provider')) aiProvider = localStorage.getItem('ai_provider');
    } catch(e) { console.log('Could not load API keys from localStorage'); }

    // Auto-detect best provider if still on free and a key is available
    if (aiProvider === 'free') {
        if (openaiKey) aiProvider = 'openai';
        else if (groqKey) aiProvider = 'groq';
        else if (geminiKey) aiProvider = 'gemini';
        else if (claudeKey) aiProvider = 'claude';
    }
    updateApiState();

    renderSidebar();
    renderOverview();
    // Show welcome page on first visit
    if (!sessionStorage.getItem('ogd_setup_done')) {
        setActivePage('welcome');
    }
    // Fetch live previews in background
    fetchOverviewPreviews();
}

function renderSidebar() {
    const nav = document.getElementById('agency-nav-list');
    let html = '';
    // Sort agencies alphabetically by acronym or name
    const sorted = [...agencies].sort((a, b) => {
        const aDisplay = (a.acronym || a.name).toLowerCase();
        const bDisplay = (b.acronym || b.name).toLowerCase();
        return aDisplay.localeCompare(bDisplay);
    });
    for (const a of sorted) {
        const endpointCount = (a.endpoints || []).length;
        html += `<div class="nav-item" data-page="agency-${a.id}" onclick="selectAgency('${a.id}')">
            ${a.acronym || a.name}
            <span class="badge">${endpointCount}</span>
        </div>`;
    }
    nav.innerHTML = html;
    document.getElementById('agency-count').textContent = `${agencies.length} agencies`;
}

let overviewCatFilter = 'All';
let overviewAuthFilter = 'all'; // 'all', 'open', 'auth'
let overviewPreviews = {}; // cache for live data previews

function renderOverview() {
    const container = document.getElementById('overview-content');
    const totalEndpoints = agencies.reduce((sum, a) => sum + (a.endpoints || []).length, 0);
    const openCount = agencies.filter(a => !a.auth_required).length;
    const authCount = agencies.filter(a => a.auth_required).length;
    const allCats = [...new Set(agencies.flatMap(a => a.data_categories || []))].sort();

    // API provider status badges
    updateApiState();
    let providerHtml = `<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">`;
    providerHtml += `<div style="padding:8px 12px;background:var(--accent-glow);border:1px solid var(--accent);border-radius:0;font-size:10px;font-family:var(--mono);"><span style="color:var(--accent);font-weight:600;">AI Chatbot:</span> ${apiState.free.configured ? '✓ Free Mode' : '○ Free Mode'}`
    + (apiState.openai.configured ? ` + ✓ ${apiState.openai.name.split(' ')[0]}` : '')
    + (apiState.groq.configured ? ` + ✓ ${apiState.groq.name.split(' ')[0]}` : '')
    + (apiState.gemini.configured ? ` + ✓ ${apiState.gemini.name.split(' ')[0]}` : '')
    + (apiState.claude.configured ? ` + ✓ ${apiState.claude.name.split(' ')[0]}` : '')
    + `</div>`;
    providerHtml += `<button onclick="showApiKeyModal()" style="padding:8px 12px;background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--mono);font-size:10px;border-radius:0;cursor:pointer;">+ Add Provider</button>`;
    providerHtml += `</div>`;

    // Consolidated stats box
    let html = providerHtml + `<div class="stats-box">
        <div class="stat-item"><span class="stat-value">${agencies.length}</span><span class="stat-label">Agencies</span></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><span class="stat-value">${totalEndpoints}</span><span class="stat-label">Endpoints</span></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><span class="stat-value">${openCount}</span><span class="stat-label">Open Access</span></div>
        <div class="stat-divider"></div>
        <div class="stat-item"><span class="stat-value">${allCats.length}</span><span class="stat-label">Categories</span></div>
    </div>`;

    // Auth filter buttons
    html += `<div class="filter-bar">
        <span class="filter-label">Access:</span>
        <button class="filter-btn ${overviewAuthFilter === 'all' ? 'active' : ''}" onclick="setOverviewAuth('all')">All<span class="filter-count">${agencies.length}</span></button>
        <button class="filter-btn ${overviewAuthFilter === 'open' ? 'active' : ''}" onclick="setOverviewAuth('open')">No Auth Required<span class="filter-count">${openCount}</span></button>
        <button class="filter-btn ${overviewAuthFilter === 'auth' ? 'active' : ''}" onclick="setOverviewAuth('auth')">Auth Required<span class="filter-count">${authCount}</span></button>
    </div>`;

    // Category filter buttons
    html += `<div class="filter-bar">
        <span class="filter-label">Category:</span>
        <button class="filter-btn ${overviewCatFilter === 'All' ? 'active' : ''}" onclick="setOverviewCat('All')">All</button>`;
    for (const cat of allCats) {
        const count = agencies.filter(a => (a.data_categories || []).includes(cat)).length;
        html += `<button class="filter-btn ${overviewCatFilter === cat ? 'active' : ''}" onclick="setOverviewCat('${cat}')">${cat}<span class="filter-count">${count}</span></button>`;
    }
    html += `</div>`;

    // Filter agencies
    let filtered = agencies;
    if (overviewAuthFilter === 'open') filtered = filtered.filter(a => !a.auth_required);
    else if (overviewAuthFilter === 'auth') filtered = filtered.filter(a => a.auth_required);
    if (overviewCatFilter !== 'All') filtered = filtered.filter(a => (a.data_categories || []).includes(overviewCatFilter));

    // Agency cards with live preview
    html += '<div class="overview-grid">';
    for (const a of filtered) {
        const tags = (a.data_categories || []).map(c => `<span class="tag">${c}</span>`).join('');
        const authBadge = a.auth_required
            ? `<span style="color:var(--warning);font-family:var(--mono);font-size:10px;">${svgIcon('lock', 10)} AUTH</span>`
            : `<span style="color:var(--success);font-family:var(--mono);font-size:10px;">${svgIcon('unlock', 10)} OPEN</span>`;
        const endpointCount = (a.endpoints || []).length;

        // Live preview items
        let previewHtml = '';
        const cached = overviewPreviews[a.id];
        if (cached && cached.length > 0) {
            previewHtml = '<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border);">';
            for (const item of cached.slice(0, 3)) {
                const d = formatDate(item.date);
                const t = (item.title || '').substring(0, 60);
                previewHtml += `<div class="agency-preview-item">${d ? `<span class="preview-date">${d}</span>` : ''}${t}</div>`;
            }
            previewHtml += '</div>';
        } else if (cached === undefined) {
            previewHtml = '<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--text-muted);animation:pulse-glow 1.5s ease-in-out infinite;">Loading previews...</div>';
        }

        html += `<div class="agency-overview-card" onclick="selectAgency('${a.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <h3>${a.acronym || a.id}</h3>
                ${authBadge}
            </div>
            <div class="acronym">${a.name} &middot; ${endpointCount} endpoints</div>
            <p>${a.description || ''}</p>
            <div class="tags">${tags}</div>
            ${previewHtml}
        </div>`;
    }
    html += '</div>';
    container.innerHTML = html;
}

function setOverviewCat(cat) {
    overviewCatFilter = cat;
    renderOverview();
}

function setOverviewAuth(auth) {
    overviewAuthFilter = auth;
    renderOverview();
}

// Fetch live preview data for all agencies on overview
async function fetchOverviewPreviews() {
    const previewAgencies = agencies.filter(a => !a.auth_required && DIRECT_API[a.id]);
    const batchSize = 4;
    for (let i = 0; i < previewAgencies.length; i += batchSize) {
        const batch = previewAgencies.slice(i, i + batchSize);
        await Promise.allSettled(batch.map(async (a) => {
            try {
                const sub = (a.sub_sections && a.sub_sections[0]) ? a.sub_sections[0].id : '';
                const data = await DIRECT_API[a.id].fetch(sub);
                overviewPreviews[a.id] = (data || []).slice(0, 3);
            } catch (e) {
                overviewPreviews[a.id] = [];
            }
            renderOverview();
        }));
    }
    // Mark agencies without DIRECT_API as empty
    for (const a of agencies) {
        if (overviewPreviews[a.id] === undefined) overviewPreviews[a.id] = [];
    }
    renderOverview();
}

// Page switching
function setActivePage(page) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (navItem) navItem.classList.add('active');

    document.getElementById('page-welcome').style.display = page === 'welcome' ? 'flex' : 'none';
    document.getElementById('page-overview').style.display = page === 'overview' ? 'block' : 'none';
    document.getElementById('page-agency').style.display = page.startsWith('agency-') ? 'flex' : 'none';
    document.getElementById('page-chat').style.display = page === 'chat' ? 'flex' : 'none';
}

function showWelcome() { setActivePage('welcome'); }
function showOverview() { setActivePage('overview'); }
function showChat() {
    setActivePage('chat');
    const names = { free: 'Free (HuggingFace)', openai: 'OpenAI GPT-4o', groq: 'Groq Llama 3', gemini: 'Google Gemini', claude: 'Claude Sonnet' };
    document.getElementById('chat-provider-badge').textContent = `Powered by ${names[aiProvider] || 'AI'}`;
}

// Welcome page functions
function selectProvider(provider) {
    aiProvider = provider;
    document.querySelectorAll('.provider-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    const keyInput = document.getElementById('provider-key-input');
    const keyLabel = document.getElementById('provider-key-label');
    const keyField = document.getElementById('welcome-api-key');
    if (provider === 'free') {
        keyInput.style.display = 'none';
    } else {
        keyInput.style.display = 'block';
        const labels = { openai: 'OpenAI API Key', groq: 'Groq API Key', gemini: 'Google Gemini API Key', claude: 'Anthropic API Key' };
        const placeholders = { openai: 'sk-...', groq: 'gsk_...', gemini: 'AI...', claude: 'sk-ant-...' };
        keyLabel.textContent = labels[provider] || 'API Key';
        keyField.placeholder = placeholders[provider] || 'Enter API key...';
    }
}

function completeSetup() {
    const keyField = document.getElementById('welcome-api-key');
    const dgField = document.getElementById('welcome-datagov-key');
    if (keyField && keyField.value.trim()) {
        const key = keyField.value.trim();
        if (aiProvider === 'openai') {
            openaiKey = key;
            try { localStorage.setItem('openai_key', key); } catch(e) {}
        } else if (aiProvider === 'groq') {
            groqKey = key;
            try { localStorage.setItem('groq_key', key); } catch(e) {}
        } else if (aiProvider === 'gemini') {
            geminiKey = key;
            try { localStorage.setItem('gemini_key', key); } catch(e) {}
        } else if (aiProvider === 'claude') {
            claudeKey = key;
            try { localStorage.setItem('claude_key', key); } catch(e) {}
        }
    }
    if (dgField && dgField.value.trim()) {
        datagovKey = dgField.value.trim();
        try { localStorage.setItem('datagov_key', dgField.value.trim()); } catch(e) {}
    }
    // Save selected provider
    try { localStorage.setItem('ai_provider', aiProvider); } catch(e) {}
    updateApiState();
    try { sessionStorage.setItem('ogd_setup_done', '1'); } catch(e) {}
    showOverview();
}

// Agency selection
let agencyViewMode = 'landing'; // 'landing' or 'data'

async function selectAgency(agencyId) {
    currentAgency = agencies.find(a => a.id === agencyId);
    if (!currentAgency) return;

    setActivePage(`agency-${agencyId}`);
    agencyViewMode = 'landing';

    document.getElementById('agency-title').textContent = currentAgency.acronym || currentAgency.name || agencyId;
    document.getElementById('agency-source').textContent = currentAgency.base_url || '';

    // Clear sub-tabs (landing shows endpoint cards instead)
    document.getElementById('sub-tabs').innerHTML = '';
    // Hide search bar, fetch controls, and view controls on landing
    document.getElementById('search-bar-container').innerHTML = '';
    document.getElementById('data-fetch-controls').innerHTML = '';
    const vc = document.querySelector('.view-controls');
    if (vc) vc.style.display = 'none';

    currentSubSection = '';
    currentData = [];

    renderAgencyLanding();
}

function buildFetchControlsHtml() {
    const today = new Date().toISOString().split('T')[0];
    return `<div class="fetch-controls" id="fetch-controls">
        <div class="fc-group">
            <label>Limit</label>
            <select id="fc-limit" onchange="updateFetchLimit(this.value)">
                <option value="10"${fetchLimit===10?' selected':''}>10</option>
                <option value="20"${fetchLimit===20?' selected':''}>20</option>
                <option value="50"${fetchLimit===50?' selected':''}>50</option>
                <option value="100"${fetchLimit===100?' selected':''}>100</option>
            </select>
        </div>
        <div class="fc-divider"></div>
        <div class="fc-group">
            <label>From</label>
            <input type="date" id="fc-date-from" value="${fetchDateFrom}" onchange="updateFetchDateFrom(this.value)" max="${today}">
        </div>
        <div class="fc-group">
            <label>To</label>
            <input type="date" id="fc-date-to" value="${fetchDateTo}" onchange="updateFetchDateTo(this.value)" max="${today}">
        </div>
        <div class="fc-divider"></div>
        <button style="font-family:var(--mono);font-size:9px;padding:4px 10px;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;text-transform:uppercase;letter-spacing:0.5px;" onclick="resetFetchControls()">Reset</button>
    </div>`;
}

function updateFetchLimit(val) { fetchLimit = parseInt(val) || 20; }
function updateFetchDateFrom(val) { fetchDateFrom = val; }
function updateFetchDateTo(val) { fetchDateTo = val; }
function resetFetchControls() {
    fetchLimit = 20; fetchDateFrom = ''; fetchDateTo = '';
    const el = document.getElementById('fc-limit'); if (el) el.value = '20';
    const df = document.getElementById('fc-date-from'); if (df) df.value = '';
    const dt = document.getElementById('fc-date-to'); if (dt) dt.value = '';
}

function renderAgencyLanding() {
    const container = document.getElementById('agency-content');
    const a = currentAgency;
    const subs = a.sub_sections || [];
    const authLabel = a.auth_required
        ? `<span style="color:var(--warning);">${svgIcon('lock', 12)} Auth Required</span>`
        : `<span style="color:var(--success);">${svgIcon('unlock', 12)} Open Access</span>`;

    // Endpoint description hints
    const epDescriptions = {
        // SEC
        '8-K': 'Current reports on major corporate events',
        '10-K': 'Annual financial reports filed by public companies',
        '10-Q': 'Quarterly financial reports',
        '13F': 'Institutional investment manager holdings',
        'S-1': 'Registration statements for IPOs',
        // FDA
        'drug_events': 'Adverse event reports for drugs and medications',
        'drug_recalls': 'Drug recall enforcement actions',
        'device_510k': 'Medical device premarket clearance filings',
        'device_recalls': 'Medical device recall enforcement',
        'food_recalls': 'Food and cosmetic recall enforcement',
        // Treasury
        'national_debt': 'Daily total public debt outstanding',
        'daily_statements': 'Daily treasury account balances',
        'interest_rates': 'Average interest rates on treasury securities',
        'exchange_rates': 'Treasury foreign currency exchange rates',
        // USAspending
        'top_agencies': 'Federal agencies ranked by budget allocation',
        'federal_accounts': 'Federal spending accounts and balances',
        // NOAA
        'alerts': 'Currently active weather alerts nationwide',
        'forecast': 'Weather forecast for Washington DC area',
        // USGS
        'earthquakes': 'Significant earthquakes in the last 30 days',
        'water': 'Real-time water monitoring station data',
        // NASA
        'apod': 'Daily astronomy image or video with explanation',
        'neo': 'Asteroids and comets approaching Earth',
        'mars': 'Latest images from Mars rover missions',
        // BLS
        'unemployment': 'National unemployment rate time series',
        'cpi': 'Consumer Price Index for all urban consumers',
        'employment': 'Total nonfarm employment numbers',
        'avg_hourly_earnings': 'Average hourly earnings data',
        // Census
        'population': 'Population estimates by state',
        'income': 'Median household income by state',
        // DOJ
        'press_releases': 'Official Department of Justice press releases',
        'blog_posts': 'DOJ blog posts and updates',
        'speeches': 'Speeches by DOJ officials',
        'news': 'DOJ news items',
        // FCC
        'equipment_auth': 'Search FCC ID filings, grantees, and equipment authorizations',
        'ecfs_filings': 'Electronic Comment Filing System proceedings',
        'complaints': 'Consumer complaint records',
        'broadband': 'Mobile broadband provider data',
        // FTC
        'press_releases': 'FTC news and press releases',
        'cases': 'Consumer protection and antitrust enforcement cases',
        // NIST
        'recent_cves': 'Recently published CVE vulnerability records',
        // FEC
        'candidates': 'Registered candidates and their committees',
        'filings': 'Committee financial filings',
        // FDIC
        'institutions': 'Active FDIC-insured financial institutions',
        'failures': 'Historical bank failure records',
        // NIH
        'clinical_trials': 'Active and recruiting clinical trials',
        'pubmed': 'Biomedical research articles',
        // LOC
        'collections': 'Library of Congress digital collections',
        // NARA
        'records': 'National Archives historical records',
        // DOT
        'recalls': 'NHTSA vehicle recall campaigns',
        'complaints': 'Vehicle safety complaint reports',
        // SAM
        'opportunities': 'Federal contract opportunity listings',
        // EPA
        'water_systems': 'Public water system data',
        'facilities': 'EPA-regulated facility information',
        'toxic_releases': 'Toxic Release Inventory facility data',
    };

    const epIcons = {
        'drug_events': svgIcon('pill'), 'drug_recalls': svgIcon('alert'), 'device_510k': svgIcon('device'), 'device_recalls': svgIcon('alert'), 'food_recalls': svgIcon('food'),
        'national_debt': svgIcon('dollar'), 'daily_statements': svgIcon('chart-up'), 'interest_rates': svgIcon('chart-bar'), 'exchange_rates': svgIcon('exchange'),
        'alerts': svgIcon('alert'), 'forecast': svgIcon('cloud'), 'earthquakes': svgIcon('quake'), 'water': svgIcon('droplet'),
        'apod': svgIcon('star'), 'neo': svgIcon('asteroid'), 'mars': svgIcon('rocket'),
        'unemployment': svgIcon('chart-bar'), 'cpi': svgIcon('chart-up'), 'employment': svgIcon('briefcase'), 'avg_hourly_earnings': svgIcon('dollar'),
        'population': svgIcon('people'), 'income': svgIcon('dollar'),
        'press_releases': svgIcon('newspaper'), 'blog_posts': svgIcon('pencil'), 'speeches': svgIcon('mic'), 'news': svgIcon('megaphone'),
        'equipment_auth': svgIcon('radio'), 'ecfs_filings': svgIcon('doc'), 'complaints': svgIcon('megaphone'), 'broadband': svgIcon('wifi'),
        'cases': svgIcon('scale'), 'recent_cves': svgIcon('shield'),
        'candidates': svgIcon('vote'), 'filings': svgIcon('doc'),
        'institutions': svgIcon('bank'), 'failures': svgIcon('siren'),
        'clinical_trials': svgIcon('flask'), 'pubmed': svgIcon('book'),
        'collections': svgIcon('book'), 'records': svgIcon('scroll'),
        'recalls': svgIcon('car'), 'opportunities': svgIcon('briefcase'),
        'water_systems': svgIcon('droplet'), 'facilities': svgIcon('factory'), 'toxic_releases': svgIcon('hazard'),
        'top_agencies': svgIcon('building'), 'federal_accounts': svgIcon('dollar'),
        '8-K': svgIcon('doc'), '10-K': svgIcon('chart-bar'), '10-Q': svgIcon('chart-up'), '13F': svgIcon('dollar'), 'S-1': svgIcon('trophy'),
    };

    let html = `<div class="agency-landing">
        <div class="agency-landing-header">
            <h2>${a.name}</h2>
            <p>${a.description || ''}</p>
            <div class="landing-meta">
                ${authLabel}
                <span style="color:var(--text-muted);">${subs.length} endpoint${subs.length !== 1 ? 's' : ''}</span>
                <span style="color:var(--text-muted);">${a.base_url || ''}</span>
            </div>
        </div>`;

    // Search section (if agency supports it)
    if (a.has_search) {
        html += `<div class="landing-search-section">
            <h4>${svgIcon('search', 14)} Search</h4>
            <div class="landing-search-row">
                <input id="agency-search" placeholder="${a.search_placeholder || 'Search...'}" onkeydown="if(event.key==='Enter')launchSearch()">
                <button onclick="launchSearch()">Search</button>
            </div>
        </div>`;
    }

    // Fetch controls
    html += buildFetchControlsHtml();

    // Endpoint cards
    html += '<div class="endpoint-grid">';
    for (const sub of subs) {
        const icon = epIcons[sub.id] || svgIcon('clipboard');
        const desc = epDescriptions[sub.id] || '';
        html += `<div class="endpoint-card" onclick="launchEndpoint('${sub.id}')">
            <div class="ep-icon">${icon}</div>
            <div class="ep-name">${sub.name}</div>
            ${desc ? `<div class="ep-desc">${desc}</div>` : ''}
            <div class="ep-tag">${svgIcon('play', 10)} LOAD</div>
        </div>`;
    }
    html += '</div>';
    html += '</div>';

    container.innerHTML = html;
}

function launchEndpoint(subId) {
    agencyViewMode = 'data';
    currentSubSection = subId;

    // Show sub-tabs now that we're in data mode
    const subTabs = document.getElementById('sub-tabs');
    const subs = currentAgency.sub_sections || [];
    subTabs.innerHTML = subs.map(s =>
        `<button class="sub-tab ${s.id === subId ? 'active' : ''}" onclick="selectSubSection('${s.id}')">${s.name}</button>`
    ).join('');
    // Add back button
    subTabs.innerHTML = `<button class="sub-tab" onclick="selectAgency('${currentAgency.id}')" style="border-color:var(--text-muted);color:var(--text-muted);">&#8592; Back</button>` + subTabs.innerHTML;

    // Show search bar if agency supports it
    const searchContainer = document.getElementById('search-bar-container');
    if (currentAgency.has_search) {
        searchContainer.innerHTML = `<div class="search-bar">
            <input id="agency-search" placeholder="${currentAgency.search_placeholder || 'Search...'}" onkeydown="if(event.key==='Enter')searchAgency()">
            <button onclick="searchAgency()">Search</button>
        </div>`;
    }

    // Show fetch controls in data view
    document.getElementById('data-fetch-controls').innerHTML = buildFetchControlsHtml();

    // Show view controls
    const vc = document.querySelector('.view-controls');
    if (vc) vc.style.display = 'flex';

    fetchAgencyData();
}

function launchSearch() {
    const query = document.getElementById('agency-search')?.value?.trim();
    if (!query) return;
    agencyViewMode = 'data';
    // Default to first sub-section for search context
    const subs = currentAgency.sub_sections || [];
    if (subs.length > 0 && !currentSubSection) currentSubSection = subs[0].id;

    // Show sub-tabs
    const subTabs = document.getElementById('sub-tabs');
    subTabs.innerHTML = `<button class="sub-tab" onclick="selectAgency('${currentAgency.id}')" style="border-color:var(--text-muted);color:var(--text-muted);">&#8592; Back</button>`;
    subTabs.innerHTML += subs.map(s =>
        `<button class="sub-tab ${s.id === currentSubSection ? 'active' : ''}" onclick="selectSubSection('${s.id}')">${s.name}</button>`
    ).join('');

    // Show fetch controls in data view
    document.getElementById('data-fetch-controls').innerHTML = buildFetchControlsHtml();

    // Show view controls
    const vc = document.querySelector('.view-controls');
    if (vc) vc.style.display = 'flex';

    fetchAgencyData(query);
}

function selectSubSection(subId) {
    currentSubSection = subId;
    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.sub-tab[onclick="selectSubSection('${subId}')"]`)?.classList.add('active');
    fetchAgencyData();
}

async function fetchAgencyData(searchQuery) {
    const container = document.getElementById('agency-content');
    container.innerHTML = '<div class="loading"><div class="spinner"></div>Fetching data...</div>';
    // Reset APOD index on new fetch
    apodIndex = 0;
    // Hide view controls for special views (APOD)
    const viewControls = document.querySelector('.view-controls');
    if (viewControls) {
        const hideViewControls = (currentAgency?.id === 'nasa' && currentSubSection === 'apod');
        viewControls.style.display = hideViewControls ? 'none' : 'flex';
    }

    const opts = { limit: fetchLimit, dateFrom: fetchDateFrom, dateTo: fetchDateTo };

    if (useDirectApi && DIRECT_API[currentAgency.id]) {
        // Client-side direct API calls
        try {
            currentData = await DIRECT_API[currentAgency.id].fetch(currentSubSection, searchQuery, opts);
            document.getElementById('result-count').textContent = `${currentData.length} results`;
            renderData();
        } catch (e) {
            container.innerHTML = `<div class="error-msg">API Error: ${e.message}<br><small>Some APIs may have CORS restrictions. Try running the Flask backend for full access.</small></div>`;
        }
        return;
    }

    // Flask backend mode
    const params = new URLSearchParams();
    if (currentSubSection) params.set('sub_section', currentSubSection);
    if (datagovKey) params.set('api_key', datagovKey);
    if (searchQuery) params.set('query', searchQuery);
    if (opts.limit) params.set('limit', opts.limit);
    if (opts.dateFrom) params.set('date_from', opts.dateFrom);
    if (opts.dateTo) params.set('date_to', opts.dateTo);

    try {
        const resp = await fetch(`${API_BASE}/api/data/${currentAgency.id}?${params}`);
        const data = await resp.json();

        if (data.error) {
            container.innerHTML = `<div class="error-msg">${data.error}</div>`;
            return;
        }

        currentData = data.results || [];
        document.getElementById('result-count').textContent = `${currentData.length} results`;
        renderData();
    } catch (e) {
        container.innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
    }
}

function searchAgency() {
    const query = document.getElementById('agency-search')?.value;
    if (!query) return;
    fetchAgencyData(query);
}

function setView(view) {
    currentView = view;
    document.getElementById('btn-cards').classList.toggle('active', view === 'cards');
    document.getElementById('btn-table').classList.toggle('active', view === 'table');
    renderData();
}

function renderData() {
    const container = document.getElementById('agency-content');
    if (!currentData || currentData.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No data available for this selection.</div>';
        return;
    }

    // Special view: NASA APOD - show image prominently
    if (currentAgency?.id === 'nasa' && currentSubSection === 'apod') {
        renderApodView(container);
        return;
    }

    // Special view: FCC detail view when search results have _fcc_detail_view flag
    if (currentAgency?.id === 'fcc' && currentData[0]?._fcc_detail_view) {
        renderFccDetailView(container, currentData[0]);
        return;
    }

    // Special view: FCC grantee list (clickable to drill into grantee code)
    if (currentAgency?.id === 'fcc' && currentData[0]?._fcc_grantee_click) {
        renderFccGranteeList(container, currentData);
        return;
    }

    if (currentView === 'cards') {
        let html = '<div class="cards-grid">';
        for (const item of currentData) {
            const desc = (item.description || '').substring(0, 200);
            const dateStr = formatDate(item.date);
            const link = item.link ? `<a href="${item.link}" target="_blank" rel="noopener">View Source &#8599;</a>` : '';

            // Extra fields
            let extras = '';
            for (const [k, v] of Object.entries(item)) {
                if (!['title','description','date','link','error'].includes(k) && v) {
                    extras += `<span>${k}: ${v}</span> `;
                }
            }

            html += `<div class="data-card">
                <h3>${item.title || 'Untitled'}</h3>
                <p>${desc}</p>
                <div class="meta">
                    ${dateStr ? `<span>${dateStr}</span>` : ''}
                    ${link}
                    ${extras ? `<span style="opacity:0.6">${extras.substring(0, 100)}</span>` : ''}
                </div>
            </div>`;
        }
        html += '</div>';
        container.innerHTML = html;
    } else {
        // Table view
        if (currentData.length === 0) return;
        const keys = Object.keys(currentData[0]).filter(k => k !== 'error');
        let html = '<table class="data-table"><thead><tr>';
        for (const k of keys) {
            html += `<th>${k}</th>`;
        }
        html += '</tr></thead><tbody>';
        for (const row of currentData) {
            html += '<tr>';
            for (const k of keys) {
                let val = row[k] || '';
                if (typeof val === 'string' && val.startsWith('http')) {
                    val = `<a href="${val}" target="_blank">Link &#8599;</a>`;
                } else if (typeof val === 'string' && val.length > 150) {
                    val = val.substring(0, 150) + '...';
                }
                html += `<td>${val}</td>`;
            }
            html += '</tr>';
        }
        html += '</tbody></table>';
        container.innerHTML = html;
    }
}

// NASA APOD special view
let apodIndex = 0;
function renderApodView(container) {
    const item = currentData[apodIndex] || currentData[0];
    if (!item) return;
    const isVideo = item.media_type === 'video' || (item.link && (item.link.includes('youtube') || item.link.includes('vimeo')));
    const imgSrc = item.link || '';
    const prevDisabled = apodIndex >= currentData.length - 1 ? 'opacity:0.3;pointer-events:none;' : '';
    const nextDisabled = apodIndex <= 0 ? 'opacity:0.3;pointer-events:none;' : '';

    container.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;height:100%;">
            <div style="display:flex;gap:8px;margin-bottom:12px;">
                <button onclick="apodNav('today')" class="sub-tab ${apodIndex === 0 ? 'active' : ''}" style="font-size:13px;padding:8px 20px;">Today's Picture</button>
                <button onclick="apodNav('prev')" class="sub-tab ${apodIndex > 0 ? 'active' : ''}" style="font-size:13px;padding:8px 20px;${prevDisabled}">&#8592; Previous</button>
                <button onclick="apodNav('next')" class="sub-tab" style="font-size:13px;padding:8px 20px;${nextDisabled}">Next &#8594;</button>
            </div>
            <div style="flex:1;display:flex;align-items:center;justify-content:center;width:100%;overflow:hidden;">
                ${isVideo
                    ? `<iframe src="${imgSrc}" style="width:90%;max-width:900px;height:500px;border:none;border-radius:0;" allowfullscreen></iframe>`
                    : `<img src="${imgSrc}" alt="${item.title || ''}" style="max-width:90%;max-height:calc(100vh - 280px);border-radius:0;box-shadow:0 4px 30px rgba(0,0,0,0.5);object-fit:contain;">`
                }
            </div>
            <div style="max-width:800px;text-align:center;margin-top:12px;">
                <h3 style="font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:4px;">${item.title || 'Astronomy Picture of the Day'}</h3>
                <div style="font-size:12px;color:var(--accent);margin-bottom:8px;">${formatDate(item.date)}</div>
                <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;max-height:120px;overflow-y:auto;">${item.description || ''}</p>
            </div>
        </div>`;
}

function apodNav(dir) {
    if (dir === 'today') apodIndex = 0;
    else if (dir === 'prev') apodIndex = Math.min(apodIndex + 1, currentData.length - 1);
    else if (dir === 'next') apodIndex = Math.max(apodIndex - 1, 0);
    renderApodView(document.getElementById('agency-content'));
}

// Also hide the view controls (Cards/Table) for APOD and FCC detail
const origSelectAgency = selectAgency;

// ========== FCC DETAIL VIEW ==========

function renderFccDetailView(container, meta) {
    const gi = meta._grantee_info;
    const equipment = meta._equipment || [];
    const gc = meta._grantee_code;
    const pc = meta._product_code;

    let html = '';

    // Grantee/Company info panel
    if (gi) {
        html += `<div class="fcc-detail-panel">
            <div class="fcc-detail-header">
                <h3>Grantee: ${gi.grantee_name || gc}</h3>
                <span class="fcc-id-badge">${gc}</span>
            </div>
            <div class="fcc-detail-body">
                <div class="fcc-field-grid">`;
        const granteeFields = [
            ['Grantee Name', gi.grantee_name],
            ['Grantee Code', gi.grantee_code],
            ['Contact', gi.contact_name],
            ['Email', gi.contact_email],
            ['Phone', gi.contact_phone],
            ['Address', [gi.physical_address_line_1, gi.physical_address_line_2].filter(Boolean).join(', ')],
            ['City', gi.physical_city],
            ['State', gi.physical_state],
            ['Zip', gi.physical_zip_code],
            ['Country', gi.physical_country_code],
            ['Last Updated', gi.last_update_date],
        ];
        for (const [label, val] of granteeFields) {
            if (val) {
                html += `<div class="fcc-field">
                    <div class="fcc-field-label">${label}</div>
                    <div class="fcc-field-value">${escapeHtml(String(val))}</div>
                </div>`;
            }
        }
        html += `</div></div></div>`;
    }

    // Equipment records header
    html += `<div style="display:flex;align-items:center;justify-content:space-between;margin:16px 0 10px;">
        <div style="font-family:var(--mono);font-size:12px;color:var(--text-primary);">
            Equipment Authorizations <span style="color:var(--accent);">(${equipment.length})</span>
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-muted);">
            Click a device to expand full details
        </div>
    </div>`;

    // Equipment list — each item is expandable
    html += '<div class="fcc-results-list">';
    for (let i = 0; i < equipment.length; i++) {
        const e = equipment[i];
        const fccId = (e.grantee_code||'') + (e.product_code||'');
        const desc = e.equipment_product_description || e.product_description || 'Device';
        const applicant = e.applicant_name || '';
        const grantDate = formatDate(e.grant_date || e.date_of_grant || '');

        // Collect all non-empty fields for detail view
        const allFields = [];
        const fieldMap = {
            'FCC ID': fccId,
            'Product Description': e.equipment_product_description || e.product_description,
            'Applicant': e.applicant_name,
            'Grantee Code': e.grantee_code,
            'Product Code': e.product_code,
            'Grant Date': formatDate(e.grant_date || e.date_of_grant),
            'Expiration Date': formatDate(e.expiration_date),
            'Equipment Class': e.equipment_class,
            'Lower Frequency (MHz)': e.lower_frequency,
            'Upper Frequency (MHz)': e.upper_frequency,
            'Power Output (W)': e.power_output,
            'Emission Designator': e.emission_designator,
            'Tolerance': e.tolerance,
            'Modulation Type': e.modulation_type,
            'Test Firm': e.test_firm,
            'TCB Scope': e.tcb_scope,
            'Application Purpose': e.application_purpose,
            'Grant Notes': e.grant_notes,
            'Rule Parts': e.rule_parts,
        };
        // Also add any raw fields from the API not in our map
        for (const [k, v] of Object.entries(e)) {
            if (v && typeof v === 'string' && v.trim() && !Object.values(fieldMap).includes(v)) {
                const prettyKey = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                if (!fieldMap[prettyKey]) fieldMap[prettyKey] = v;
            }
        }

        let detailFieldsHtml = '<div class="fcc-field-grid">';
        for (const [label, val] of Object.entries(fieldMap)) {
            if (val && String(val).trim()) {
                detailFieldsHtml += `<div class="fcc-field">
                    <div class="fcc-field-label">${label}</div>
                    <div class="fcc-field-value">${escapeHtml(String(val))}</div>
                </div>`;
            }
        }
        detailFieldsHtml += '</div>';

        // Links to FCC pages for this device
        const exhibitUrl = `https://apps.fcc.gov/oetcf/eas/reports/ViewExhibitReport.cfm?mode=Exhibits&RequestTimeout=500&calledFromFrame=N&application_id=&fcc_id=${fccId}`;
        const grantUrl = `https://apps.fcc.gov/oetcf/eas/reports/ViewExhibitReport.cfm?mode=Grant&RequestTimeout=500&calledFromFrame=N&application_id=&fcc_id=${fccId}`;
        const corrUrl = `https://apps.fcc.gov/oetcf/eas/reports/ViewExhibitReport.cfm?mode=Correspondence&RequestTimeout=500&calledFromFrame=N&application_id=&fcc_id=${fccId}`;
        const fccidIoUrl = `https://fccid.io/${fccId}`;

        html += `<div class="fcc-result-item" id="fcc-item-${i}" onclick="toggleFccItem(${i})">
            <div class="fcc-result-summary">
                <span class="fcc-rid">${fccId || 'N/A'}</span>
                <span class="fcc-rdesc">${escapeHtml(desc)}</span>
                <span class="fcc-rdate">${grantDate}</span>
            </div>
            <div class="fcc-result-detail">
                ${detailFieldsHtml}
                <div class="fcc-detail-links">
                    <a class="fcc-link-btn" href="${exhibitUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${svgIcon('doc', 12)} Test Reports &amp; Exhibits</a>
                    <a class="fcc-link-btn" href="${grantUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${svgIcon('check', 12)} Grant Document</a>
                    <a class="fcc-link-btn" href="${corrUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${svgIcon('mail', 12)} Correspondence</a>
                    <a class="fcc-link-btn" href="${fccidIoUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">${svgIcon('globe', 12)} fccid.io</a>
                </div>
            </div>
        </div>`;
    }
    html += '</div>';

    container.innerHTML = html;

    // Hide cards/table view controls for this mode
    const vc = document.querySelector('.view-controls');
    if (vc) vc.style.display = 'none';
}

function toggleFccItem(index) {
    const el = document.getElementById(`fcc-item-${index}`);
    if (el) el.classList.toggle('expanded');
}

function renderFccGranteeList(container, data) {
    let html = `<div style="font-family:var(--mono);font-size:12px;color:var(--text-primary);margin-bottom:12px;">
        Found <span style="color:var(--accent);">${data.length}</span> matching grantees — click one to see all their FCC filings
    </div>`;
    html += '<div class="fcc-results-list">';
    for (const item of data) {
        html += `<div class="fcc-result-item" onclick="fccDrillGrantee('${escapeHtml(item.grantee_code || '')}')">
            <div class="fcc-result-summary">
                <span class="fcc-rid">${item.grantee_code || ''}</span>
                <span class="fcc-rdesc">${escapeHtml(item.title || '')}</span>
                <span class="fcc-rdate">${item.description || ''}</span>
            </div>
        </div>`;
    }
    html += '</div>';
    container.innerHTML = html;
}

function fccDrillGrantee(code) {
    if (!code) return;
    // Put the grantee code in the search box and re-search
    const searchInput = document.getElementById('agency-search');
    if (searchInput) searchInput.value = code;
    fetchAgencyData(code);
}

// Chat functions
const CHAT_SYSTEM_PROMPT = `You are an AI assistant for OpenGovDash, a government data dashboard.
You help users analyze, cross-reference, and understand data from multiple US government agencies.

Available agencies: SEC (EDGAR filings), FDA (drug events, recalls, 510k), Treasury (debt, rates),
USAspending (federal spending), NOAA (weather), EPA (environmental), Census (demographics),
DOJ (press releases), BLS (employment, CPI), FCC (broadband, spectrum), USGS (earthquakes),
NASA (space data), FTC (consumer protection), NIST (CVE vulnerabilities), SAM.gov (contracts),
FEC (campaign finance), FDIC (banking), NIH (clinical trials, PubMed), LOC (library), NARA (archives), DOT/NHTSA (vehicle recalls).

Cross-reference relationships:
- FCC device registrations (FCC ID) may also appear in FDA 510(k) for medical devices that transmit RF
- FCC grantee codes map to specific companies — search SEC EDGAR for their filings
- FCC Equipment Authorization data includes frequency ranges, power output, emission designators
- An FCC ID has two parts: grantee code (3-5 chars identifying the company) + product code (device identifier)
- To fully research a device: search FCC ID for equipment details, then cross-ref the applicant in SEC, FDA 510(k), and FTC
- SEC filings for pharma companies relate to FDA drug approvals
- EPA facility data connects with SEC environmental disclosures
- FDIC bank data connects with Treasury financial data
- BLS employment data correlates with Census demographics
- USAspending contracts connect with SAM.gov opportunities
- NIST CVEs relate to FCC/FTC cybersecurity enforcement
- FTC data security cases cross-reference with SEC cyber incident 8-K filings

Analyze data, suggest cross-references, and explain regulatory relationships.`;

function getActiveKey() {
    if (aiProvider === 'openai') return openaiKey;
    if (aiProvider === 'groq') return groqKey;
    if (aiProvider === 'gemini') return geminiKey;
    if (aiProvider === 'claude') return claudeKey;
    if (aiProvider === 'free') return 'free';
    return '';
}

function buildMessages(msg) {
    let systemContent = CHAT_SYSTEM_PROMPT;
    if (currentData.length > 0) {
        systemContent += `\n\nCurrent data context:\nAgency: ${currentAgency?.name}\nSample data: ${JSON.stringify(currentData.slice(0,3)).substring(0,1500)}`;
    }
    const messages = [{role:'system', content: systemContent}];
    for (const h of chatHistory.slice(-10)) {
        messages.push({role: h.role, content: h.content});
    }
    messages.push({role:'user', content: msg});
    return messages;
}

async function callAI(messages) {
    const provider = aiProvider;

    if (provider === 'free') {
        // HuggingFace free serverless inference — no API key, OpenAI-compatible
        const freeModels = [
            'Qwen/Qwen2.5-72B-Instruct',
            'mistralai/Mixtral-8x7B-Instruct-v0.1',
            'meta-llama/Meta-Llama-3-8B-Instruct'
        ];
        for (const model of freeModels) {
            try {
                const url = `https://api-inference.huggingface.co/models/${model}/v1/chat/completions`;
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, messages, max_tokens: 1500, temperature: 0.7 })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.choices?.[0]) return data;
                }
                // If 503 (model loading) or 429 (rate limit), try next model
            } catch (e) { /* try next model */ }
        }
        return { error: { message: 'Free models are busy. Try again in a moment, or switch to Groq (free key at groq.com) for reliable access.' } };
    }

    if (provider === 'groq') {
        if (!groqKey) throw new Error('Groq API key is required. Set it in AI Provider Settings.');
        try {
            const resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${groqKey}`},
                body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages, max_tokens:2000, temperature:0.7 })
            });
            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                return { error: { message: `Groq ${resp.status}: ${errData?.error?.message || resp.statusText}` } };
            }
            return await resp.json();
        } catch (fetchErr) {
            throw new Error(`Network error: ${fetchErr.message}. If using file://, switch to http://localhost instead.`);
        }
    }

    if (provider === 'openai') {
        if (!openaiKey) throw new Error('OpenAI API key is missing. Open API Key settings and save your key.');
        console.log('[OpenGovDash] Calling OpenAI with key:', openaiKey.substring(0,8) + '...');
        try {
            const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${openaiKey}`},
                body: JSON.stringify({ model:'gpt-4o-mini', messages, max_tokens:2000, temperature:0.7 })
            });
            if (!resp.ok) {
                const errData = await resp.json().catch(() => ({}));
                return { error: { message: `OpenAI ${resp.status}: ${errData?.error?.message || resp.statusText}` } };
            }
            return await resp.json();
        } catch (fetchErr) {
            throw new Error(`Network error: ${fetchErr.message}. If using file://, switch to http://localhost instead.`);
        }
    }

    if (provider === 'gemini') {
        // Gemini uses a different format
        const contents = messages.filter(m => m.role !== 'system').map(m => ({
            role: m.role === 'assistant' ? 'model' : 'user',
            parts: [{text: m.content}]
        }));
        const systemInstruction = messages.find(m => m.role === 'system');
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                contents,
                systemInstruction: systemInstruction ? {parts:[{text:systemInstruction.content}]} : undefined,
                generationConfig: { maxOutputTokens: 2000, temperature: 0.7 }
            })
        });
        const data = await resp.json();
        if (data.error) return { error: data.error };
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
        return { choices: [{ message: { content: text } }] };
    }

    if (provider === 'claude') {
        const systemMsg = messages.find(m => m.role === 'system')?.content || '';
        const userMsgs = messages.filter(m => m.role !== 'system');
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type':'application/json',
                'x-api-key': claudeKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2000,
                system: systemMsg,
                messages: userMsgs
            })
        });
        const data = await resp.json();
        if (data.error) return { error: data.error };
        const text = data.content?.[0]?.text || 'No response';
        return { choices: [{ message: { content: text } }] };
    }

    throw new Error(`Unknown provider: ${provider}`);
}

async function sendChat() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;

    // Check if selected provider is ready
    updateApiState();
    if (!isProviderReady(aiProvider)) {
        showProviderSetupModal(aiProvider);
        return;
    }

    input.value = '';
    appendChat('user', msg);
    const typingId = 'typing-' + Date.now();
    appendTyping(typingId);

    try {
        const messages = buildMessages(msg);
        const data = await callAI(messages);
        removeTyping(typingId);

        if (data.error) {
            appendChat('assistant', `Error: ${data.error.message || JSON.stringify(data.error)}`);
        } else {
            const providerNames = { free: 'Free (HuggingFace)', openai: 'OpenAI GPT-4o', groq: 'Groq Llama 3', gemini: 'Google Gemini', claude: 'Claude Sonnet' };
            const providerTag = `[${providerNames[aiProvider] || aiProvider}]`;
            const content = data.choices?.[0]?.message?.content || 'No response';
            // Display with tag, but store clean content in history
            appendChat('assistant', `${providerTag} ${content}`, {historyContent: content});
        }
    } catch (e) {
        removeTyping(typingId);
        appendChat('assistant', `Error: ${e.message}`);
    }
}

function sendSuggestion(el) {
    document.getElementById('chat-input').value = el.textContent;
    showChat();
    sendChat();
}

function appendChat(role, content, opts = {}) {
    // Store clean content in history (no display tags) unless it's a system notice
    if (!opts.noHistory) {
        const cleanContent = opts.historyContent || content;
        chatHistory.push({role, content: cleanContent});
    }
    const container = document.getElementById('chat-messages');
    const avatar = role === 'user' ? svgIcon('user', 14) : svgIcon('bot', 14);
    container.innerHTML += `<div class="chat-message ${role}">
        ${role === 'assistant' ? `<div class="chat-avatar">${avatar}</div>` : ''}
        <div class="chat-bubble">${escapeHtml(content)}</div>
        ${role === 'user' ? `<div class="chat-avatar">${avatar}</div>` : ''}
    </div>`;
    container.scrollTop = container.scrollHeight;
}

function appendTyping(id) {
    const container = document.getElementById('chat-messages');
    container.innerHTML += `<div class="chat-message assistant" id="${id}">
        <div class="chat-avatar">${svgIcon('bot', 14)}</div>
        <div class="chat-bubble"><div class="spinner" style="display:inline-block;width:16px;height:16px;border-width:2px;vertical-align:middle;margin-right:6px;"></div>Thinking...</div>
    </div>`;
    container.scrollTop = container.scrollHeight;
}

function removeTyping(id) {
    document.getElementById(id)?.remove();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// API Key modal
function showApiKeyModal() {
    document.getElementById('api-key-modal').style.display = 'flex';
    document.getElementById('modal-provider-select').value = aiProvider;
    document.getElementById('datagov-key-input').value = datagovKey;
    modalProviderChange();
    // Load existing key
    const keyInput = document.getElementById('modal-key-input');
    if (aiProvider === 'openai') keyInput.value = openaiKey;
    else if (aiProvider === 'groq') keyInput.value = groqKey;
    else if (aiProvider === 'gemini') keyInput.value = geminiKey;
    else if (aiProvider === 'claude') keyInput.value = claudeKey;
}

function modalProviderChange() {
    const provider = document.getElementById('modal-provider-select').value;
    const keySection = document.getElementById('modal-key-section');
    const keyLabel = document.getElementById('modal-key-label');
    const keyInput = document.getElementById('modal-key-input');

    if (provider === 'free') {
        keySection.style.display = 'none';
    } else {
        keySection.style.display = 'block';
        const labels = { openai: 'OpenAI API Key', groq: 'Groq API Key', gemini: 'Google Gemini API Key', claude: 'Anthropic API Key' };
        const placeholders = { openai: 'sk-...', groq: 'gsk_...', gemini: 'AI...', claude: 'sk-ant-...' };

        // Load existing key for this provider
        let existingKey = '';
        if (provider === 'openai') existingKey = openaiKey;
        else if (provider === 'groq') existingKey = groqKey;
        else if (provider === 'gemini') existingKey = geminiKey;
        else if (provider === 'claude') existingKey = claudeKey;

        keyInput.value = existingKey;

        // Update label with status badge
        const statusBadge = existingKey ? ' <span style="color:var(--accent-success, #10b981);font-size:11px;margin-left:6px;">✓ Configured</span>' : '';
        keyLabel.innerHTML = (labels[provider] || 'API Key') + statusBadge;
        keyInput.placeholder = placeholders[provider] || 'Enter API key...';
    }
}

function closeApiKeyModal() {
    document.getElementById('api-key-modal').style.display = 'none';
}

function saveApiKeys() {
    aiProvider = document.getElementById('modal-provider-select').value;
    const key = document.getElementById('modal-key-input')?.value?.trim() || '';

    // Save to memory AND localStorage
    if (aiProvider === 'openai') {
        openaiKey = key;
        try { localStorage.setItem('openai_key', key); } catch(e) {}
    }
    else if (aiProvider === 'groq') {
        groqKey = key;
        try { localStorage.setItem('groq_key', key); } catch(e) {}
    }
    else if (aiProvider === 'gemini') {
        geminiKey = key;
        try { localStorage.setItem('gemini_key', key); } catch(e) {}
    }
    else if (aiProvider === 'claude') {
        claudeKey = key;
        try { localStorage.setItem('claude_key', key); } catch(e) {}
    }

    // Save selected provider
    try { localStorage.setItem('ai_provider', aiProvider); } catch(e) {}

    datagovKey = document.getElementById('datagov-key-input').value.trim();
    if (datagovKey) try { localStorage.setItem('datagov_key', datagovKey); } catch(e) {}

    updateApiState();
    closeApiKeyModal();

    // Show confirmation in chat area
    const providerNames = { free: 'Free (HuggingFace)', openai: 'OpenAI GPT-4o', groq: 'Groq Llama 3', gemini: 'Google Gemini', claude: 'Claude Sonnet' };
    const name = providerNames[aiProvider] || aiProvider;
    if (key || aiProvider === 'free') {
        appendChat('assistant', `✓ Switched to ${name}. ${aiProvider !== 'free' ? 'API key saved.' : ''} Ready to chat!`, {noHistory: true});
    }
}

// Provider setup modal - guides user through getting API keys
function showProviderSetupModal(provider) {
    const state = apiState[provider];
    if (!state || provider === 'free') return; // Free doesn't need setup

    const modal = document.getElementById('provider-setup-modal');
    const title = modal.querySelector('h3');
    const content = modal.querySelector('.setup-content');

    title.textContent = `Set up ${state.name}`;

    let html = `<p style="margin-bottom:12px;color:var(--text-secondary);font-size:13px;">Follow these steps to get your API key:</p>`;
    html += `<ol style="margin:0;padding-left:20px;color:var(--text-secondary);font-size:12px;line-height:1.8;">`;
    for (const step of state.setupSteps) {
        html += `<li>${step}</li>`;
    }
    html += `</ol>`;
    html += `<div style="margin-top:16px;padding:12px;background:var(--bg-primary);border:1px solid var(--border);border-radius:0;">
        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:6px;text-transform:uppercase;">Paste your API key</label>
        <input id="setup-key-input" type="password" placeholder="Paste key here..." style="width:100%;padding:8px 12px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:12px;border-radius:0;outline:none;">
    </div>`;
    html += `<div style="margin-top:12px;display:flex;gap:8px;">
        <button onclick="saveSetupKey('${provider}')" style="flex:1;padding:8px 12px;background:var(--accent);color:var(--bg-primary);border:none;border-radius:0;cursor:pointer;font-size:12px;font-weight:500;">Save Key</button>
        <button onclick="closeProviderSetupModal()" style="flex:1;padding:8px 12px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);border-radius:0;cursor:pointer;font-size:12px;">Cancel</button>
    </div>`;
    html += `<a href="${state.setupUrl}" target="_blank" style="display:block;margin-top:12px;text-align:center;color:var(--accent);text-decoration:none;font-size:11px;">Open ${state.name} console →</a>`;

    content.innerHTML = html;
    modal.style.display = 'flex';
}

function closeProviderSetupModal() {
    document.getElementById('provider-setup-modal').style.display = 'none';
}

function saveSetupKey(provider) {
    const key = document.getElementById('setup-key-input').value.trim();
    if (!key) {
        alert('Please paste your API key');
        return;
    }

    // Save to memory AND localStorage
    let currentKey = '';
    if (provider === 'openai') {
        currentKey = openaiKey;
        openaiKey = key;
        try { localStorage.setItem('openai_key', key); } catch(e) {}
    }
    else if (provider === 'groq') {
        currentKey = groqKey;
        groqKey = key;
        try { localStorage.setItem('groq_key', key); } catch(e) {}
    }
    else if (provider === 'gemini') {
        currentKey = geminiKey;
        geminiKey = key;
        try { localStorage.setItem('gemini_key', key); } catch(e) {}
    }
    else if (provider === 'claude') {
        currentKey = claudeKey;
        claudeKey = key;
        try { localStorage.setItem('claude_key', key); } catch(e) {}
    }

    // Also switch active provider to the one just configured
    aiProvider = provider;
    try { localStorage.setItem('ai_provider', provider); } catch(e) {}

    updateApiState();
    closeProviderSetupModal();

    // Show confirmation in chat (don't pollute history sent to AI)
    const action = currentKey ? 'updated' : 'configured';
    appendChat('assistant', `✓ ${apiState[provider].name} is now ${action}. Ready to chat!`, {noHistory: true});
}

// Multi-provider setup from welcome page
function startMultiProviderSetup(provider) {
    showProviderSetupModal(provider);
}

// Update welcome page provider status badges
function refreshMultiProviderStatus() {
    updateApiState();
    document.querySelectorAll('.provider-setup-option').forEach(el => {
        const prov = el.dataset.provider;
        const status = el.querySelector('.pso-status');
        const btn = el.querySelector('.pso-btn');
        if (apiState[prov]?.configured) {
            status.textContent = '✓ Added';
            status.style.color = 'var(--success)';
            btn.textContent = 'Update';
        } else {
            status.textContent = 'Not set';
            status.style.color = 'var(--text-muted)';
            btn.textContent = 'Add';
        }
    });
}

// Start
init();
refreshMultiProviderStatus();
</script>
</body>
</html>
